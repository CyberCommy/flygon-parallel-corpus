- en: Restoring Data
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Recovering from mysqldump and mysqlpump
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Recovering from mydumper using myloader
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Recovering from flat file backup
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Performing point-in-time recovery
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you will learn about various backup restoration methods. Assume
    that the backups and binary logs are available on the  server.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: Recovering from mysqldump and mysqlpump
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The logical backup tools `mysqldump` and `mysqlpump` write data to a single
    file.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Log in to the server where the backups are available:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To restore on the remote server, you can mention the `-h <hostname>` option:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'When you are restoring a backup, the backup statements will be logged to the
    binary log, which can slow down the restoration process. If you do not want the
    restoration process to write to the binary log, you can disable it at the session
    level using the `SET SQL_LOG_BIN=0;` option:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Or using:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-18
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: There's more...
  id: totrans-19
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Since backup restoration takes a very long time, it is recommended to start
    the restoration process inside a screen session so that even if you lose connectivity
    to the server, the restoration will continue.
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Sometimes, there can be failures during restoration. If you pass the `--force`
    option to MySQL, restoration will continue:'
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Recovering from mydumper using myloader
  id: totrans-23
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '`myloader` is a tool used for multi-threaded restoration of backups taken using
    `mydumper`. `myloader` comes along with `mydumper` and you don''t need to install
    it separately. In this section, you will learn the various ways to restore a backup.'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-25
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The common options for `myloader` are the hostname of the MySQL server to connect
    to (the default is `localhost`), username, password, and port.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: Recovering full database
  id: totrans-27
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The options are explained as follows:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: '`--overwrite-tables`: This option drops the tables if they already exist'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--compress-protocol` : This option uses compression on the MySQL connection'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--threads` : This option specifies the number of threads to use; the default
    is `4`'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--queries-per-transaction` : This specifies the number of queries per transaction;
    the default is `1000`'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`--directory`: This specifies the directory of the dump to import'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Recover a single database
  id: totrans-35
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: You can specify `--source-db <db_name>` to restore only a single database.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: 'Suppose you want to restore the `company` database:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Recovering a single table
  id: totrans-39
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '`mydumper` writes the backup of each table to a separate `.sql` file. You can
    pick up the `.sql` file and restore:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: If the table is split into chunks, you can copy all the chunks and information
    related to the table to a directory and specify the location.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: 'Copy the required files:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Use `myloader` to load; it will automatically detect the chunks and load them:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Recovering from flat file backup
  id: totrans-47
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Recovering from flat files requires you to stop the MySQL server, replace all
    the files, change the permissions, and start MySQL.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-49
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Stop the MySQL server:'
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Move the files to the `data directory`:'
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Change the ownership to `mysql`:'
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Start MySQL:'
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'To minimize the downtime, if you have enough space on disk, you can copy to
    the backup to `/var/lib/mysql2`. Then stop MySQL, rename the directory, and start
    the server:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Performing point-in-time recovery
  id: totrans-60
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Once the full backup is restored, you need to restore binary logs to get point-in-time
    recovery. The backups provide the binary log coordinates up to which the backups
    are available.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
- en: As explained in [Chapter 7](part0250.html#7EDCK0-faa69fe6f4c04957afca3568dcd9cd83),
    *Backups*,  in the *Locking instance for backup* section, you should choose the
    binary log backup from the right server, based on the `--dump-slave` or `--master-data`
    option specified in `mysqldump`.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-63
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Let's get into the details of doing it. There's a lot to learn here though.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: mysqldump or mysqlpump
  id: totrans-65
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The binary log information is stored in the SQL file as the `CHANGE MASTER TO`
    command based on the options you passed to `mysqldump`/`mysqlpump`.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: 'If you have used `--master-data`, you should use the binary logs of the slave:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果您使用了`--master-data`，您应该使用从服务器的二进制日志：
- en: '[PRE15]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: In this case, you should start the restore from the `server1.000008` file at
    position `154` on the slave.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，您应该从从服务器上位置`154`的`server1.000008`文件开始恢复。
- en: '[PRE16]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'If you have used `--dump-slave`, you should use the binary logs of the master:'
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果您使用了`--dump-slave`，您应该使用主服务器的二进制日志：
- en: '[PRE17]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: In this case, you should start the restore from the `centos7-bin.000001` file at
    position `463` located from the master.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，您应该从主服务器上位置`463`的`centos7-bin.000001`文件开始恢复。
- en: '[PRE18]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: mydumper
  id: totrans-75
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: mydumper
- en: 'The binary log information is available in the metadata:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 二进制日志信息可在元数据中找到。
- en: '[PRE19]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'If you have taken the binary log backup from the slave, you should start the
    restore from the `server1.000012` file at position `154` (`SHOW MASTER STATUS`):'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您已经从从服务器上获取了二进制日志备份，您应该从位置`154`的`server1.000012`文件开始恢复（`SHOW MASTER STATUS`）：
- en: '[PRE20]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'If you have a binary log backup from the master, you should start the restore
    from `centos7-bin.000001` at position `463` (`SHOW SLAVE STATUS`):'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您从主服务器上有二进制日志备份，您应该从位置`463`的`centos7-bin.000001`文件开始恢复（`SHOW SLAVE STATUS`）：
- en: '[PRE21]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
