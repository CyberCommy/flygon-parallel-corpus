- en: Configuring MySQL
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following recipes:'
  prefs: []
  type: TYPE_NORMAL
- en: Using config file
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using global and session variables
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using parameters with startup script
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configuring the parameters
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Changing the data directory
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'MySQL has two types of parameters:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Static**, which takes effect after restarting MySQL server'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Dynamic**, which can be changed on the fly without restarting MySQL server'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Variables can be set through the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Config file**: MySQL has a configuration file in which we can specify the
    location of data, the memory that MySQL can use, and various other parameters.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Startup script**: You can directly pass the parameters to the `mysqld` process.
    It remains in effect only for that invocation of the server.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Using SET command** (only dynamic variables): This will last until the server
    restarts. You also need to set the variable in the config file to make the change
    persistent across restarts. Another way to make changes persistent is by preceding
    the variable name by the `PERSIST` keyword or `@@persist`.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using config file
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The default config file is `/etc/my.cnf` (on Red Hat and CentOS systems) and
    `/etc/mysql/my.cnf` (Debian systems). Open the file in your favorite editor and
    modify the parameters as needed. The main parameters are discussed in this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The config file has sections specified by `section_name`. All the parameters
    related to a section can be put under them, for example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '`[mysql]`: Section is read by the `mysql` command-line client'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`[client]`: Section is read by all connecting clients (including `mysql cli`)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`[mysqld]`: Section is read by the `mysql` server'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`[mysqldump]`: The section is read by the backup utility called `mysqldump`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`[mysqld_safe]`: Read by the `mysqld_safe` process (MySQL Server Startup Script)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Apart from that the `mysqld_safe` process reads all options from the `[mysqld]`
    and `[server]` sections in option files.
  prefs: []
  type: TYPE_NORMAL
- en: For example, `mysqld_safe` process reads the `pid-file` option from `mysqld`
    section.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: In systems that use `systemd`, `mysqld_safe` will not be installed. To configure
    the startup script, you need to set the values in `/etc/systemd/system/mysqld.service.d/override.conf`.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: Using global and session variables
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As you have seen in the previous chapters, you can set the parameters by connecting
    to MySQL and executing the `SET` command.
  prefs: []
  type: TYPE_NORMAL
- en: 'There are two types of variables based on the scope of the variable:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Global**: Applies to all the new connections'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Session**: Applies only to the current connection (session)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'For example, if you want to log all queries that are slower than one second,
    you can execute:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'To make the changes persistent across restarts use:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Or:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: The persisted global system variable settings are stored in mysqld-auto.cnf
    which is located in data directory.
  prefs: []
  type: TYPE_NORMAL
- en: 'Suppose you want to log queries only for this session and not for all the connections.
    You can use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: Using parameters with startup script
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Suppose you wish to start MySQL using a startup script and not through `systemd`,
    especially for testing or for some temporary change. You can pass the variables
    to the script rather than changing it in the config file.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: You can see that the `--init-file` parameter is passed to the server. The server
    executes the SQL statements in that file before starting.
  prefs: []
  type: TYPE_NORMAL
- en: Configuring the parameters
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: After installation, the basic things you need to configure are covered in this
    section. The rest all can be left as default or tuned later according to the load.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Let's get into the details.
  prefs: []
  type: TYPE_NORMAL
- en: data directory
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Data managed by the MySQL server is stored under a directory known as the `data
    directory`. Each sub-directory of the `data directory` is a database directory
    and corresponds to a database managed by the server. By default, the
  prefs: []
  type: TYPE_NORMAL
- en: '`data directory` has three sub directories:'
  prefs: []
  type: TYPE_NORMAL
- en: '`mysql`: MySQL system database'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`performance_schema`: Provides information used to inspect the internal execution
    of the server at runtime'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`sys`: Provides a set of objects to help interpret performance schema information
    more easily'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Apart from these, the `data directory` contains the log files, `InnoDB` tablespace
    and `InnoDB` log files, SSL and RSA key files, `pid` of `mysqld`, and `mysqld-auto.cnf`,
    which stores persisted global system variable settings.
  prefs: []
  type: TYPE_NORMAL
- en: 'To set the `data directory` change/add the value of `datadir` to the config
    file. The default is `/var/lib/mysql`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: You can set it to wherever you want to store the data, but you should change
    the ownership of the `data directory` to `mysql`.
  prefs: []
  type: TYPE_NORMAL
- en: Make sure that the disk volume bearing the `data directory` has sufficient space
    to hold all your data.
  prefs: []
  type: TYPE_NORMAL
- en: innodb_buffer_pool_size
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This is the most important tuning parameter that decides how much memory the `InnoDB`
    storage engine can use to cache data and indexes in memory. Setting it too low
    can degrade the performance of the MySQL server, and setting it too high can increase
    the memory consumption of MySQL process. The best thing about MySQL 8 is that `innodb_buffer_pool_size`
    is dynamic, meaning you can vary `innodb_buffer_pool_size` without restarting
    the server.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is a simple guide on how to tune it:'
  prefs: []
  type: TYPE_NORMAL
- en: Find out the size of your dataset. Do not set the value of `innodb_buffer_pool_size`
    higher than that of your dataset. Suppose you have a 12 GB RAM machine and your
    dataset is 3 GB; then you can set `innodb_buffer_pool_size` to 3 GB. If you expect
    growth in your data, you can increase it as and when needed without restarting
    MySQL.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Usually, the size of the dataset is much bigger than the available RAM. Out
    of the total RAM, you can set some for the operating system, some for other processes,
    some for per-thread buffers inside MySQL, and some for the MySQL server apart
    from `InnoDB`. The rest can be assigned to the `InnoDB` buffer pool size.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This is a very generic table and gives you a good value to start with, assuming
    that it is a dedicated MySQL server, all the tables are `InnoDB`, and per-thread
    buffers are left as default. If the system is running out of memory, you can decrease
    the buffer pool dynamically.
  prefs: []
  type: TYPE_NORMAL
- en: '| **RAM** | **Buffer Pool Size (Range)** |'
  prefs: []
  type: TYPE_TB
- en: '| 4 GB | 1 GB-2 GB |'
  prefs: []
  type: TYPE_TB
- en: '| 8 GB | 4 GB-6 GB |'
  prefs: []
  type: TYPE_TB
- en: '| 12 GB | 6 GB-10 GB |'
  prefs: []
  type: TYPE_TB
- en: '| 16 GB | 10 GB-12 GB |'
  prefs: []
  type: TYPE_TB
- en: '| 32 GB | 24 GB-28 GB |'
  prefs: []
  type: TYPE_TB
- en: '| 64 GB | 45 GB-56 GB |'
  prefs: []
  type: TYPE_TB
- en: '| 128 GB | 108 GB-116 GB |'
  prefs: []
  type: TYPE_TB
- en: '| 256 GB | 220 GB-245 GB |'
  prefs: []
  type: TYPE_TB
- en: innodb_buffer_pool_instances
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: You can divided the `InnoDB` buffer pool into separate regions to improve concurrency,
    by reducing contention as different threads read and write to cached pages. For
    example, if the buffer pool size is 64 GB and `innodb_buffer_pool_instances` are
    32, the buffer is split into 32 regions with 2 GB each.
  prefs: []
  type: TYPE_NORMAL
- en: If the buffer pool size is more than 16 GB, you can set the instances so that
    each region gets at least 1 GB of space.
  prefs: []
  type: TYPE_NORMAL
- en: innodb_log_file_size
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This is the size of the redo log space used to replay committed transactions
    in case of a database crash. The default is 48 MB, which may not be sufficient
    for production workloads. To start with, you can set 1 GB or 2 GB. This change
    requires a restart. Stop the MySQL server and make sure that it shuts down without
    errors. Make the changes in `my.cnf` and start the server. In earlier versions,
    you need to stop the server, remove the log files, and then start the server.
    In MySQL 8, it is automatic. Modifying the redo log files is explained in [Chapter
    11](part0388.html#BI0Q80-faa69fe6f4c04957afca3568dcd9cd83), *Managing Tablespace*,
    in the *Changing the number or size of InnoDB redo log files* section.
  prefs: []
  type: TYPE_NORMAL
- en: Changing the data directory
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Your data can grow over time, and when it outgrows the filesystem, you need
    to add a disk or move the `data directory` to a bigger volume.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Check the current `data directory`. By default, the `data directory` is `/var/lib/mysql`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'Stop `mysql` and make sure it has stopped successfully:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'Check the status:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: It should show `Stopped MySQL Community Server`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Create the directory at the new location and change the ownership to `mysql`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Move the files to the new `data directory`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'In Ubuntu, if you''ve enabled AppArmor, you need to configure the Access Control:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'Start MySQL server and verify that the `data` directory has changed:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'Verify that the data is intact and remove the old `data directory`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'If MySQL fails to starts with the error—`MySQL data dir not found at /var/lib/mysql,
    please create one`:'
  prefs: []
  type: TYPE_NORMAL
- en: Execute, `sudo mkdir /var/lib/mysql/mysql -p`
  prefs: []
  type: TYPE_NORMAL
- en: If it says `MySQL system database not found`, run the ;`mysql_install_db` tool,
    which creates the required directories.
  prefs: []
  type: TYPE_NORMAL
