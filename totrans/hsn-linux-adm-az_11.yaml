- en: 'Chapter 11: Troubleshooting and Monitoring Your Workloads'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第11章：故障排除和监视工作负载
- en: Troubleshooting and logging are very much related; you start analyzing the Event,
    Service and System logs when you experience problems.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 故障排除和日志记录非常相关；当您遇到问题时，您开始分析事件、服务和系统日志。
- en: Troubleshooting problems and fixing the problems found in a cloud environment
    can be different from troubleshooting in more classic deployments. This chapter
    explains the differences, the challenges, and the new possibilities of troubleshooting
    Linux workloads in the Azure environment.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在云环境中解决问题和修复问题可能与在更经典的部署中进行故障排除不同。本章解释了在Azure环境中故障排除Linux工作负载的差异、挑战和新可能性。
- en: 'By the end of this chapter, you''ll be able to:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章结束时，您将能够：
- en: Achieve performance analysis in a Linux system using different tools.
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用不同工具在Linux系统中进行性能分析。
- en: Monitor metrics such as CPU, memory, storage, and network details.
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监视CPU、内存、存储和网络等指标的详细信息。
- en: Use Azure tooling to identify and fix problems.
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Azure工具识别和解决问题。
- en: Use Linux tooling to identify and fix problems.
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Linux工具识别和解决问题。
- en: Technical Requirements
  id: totrans-8
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 技术要求
- en: For this chapter, you'll need one or two VMs running a Linux distribution. You
    can use the smallest size if you want. The `audit` daemon must be installed and,
    for the purpose of having audit system logs to analyze and understand, it's a
    good idea to install Apache and a MySQL/MariaDB server.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 对于本章，您需要运行Linux发行版的一个或两个VM。如果您愿意，可以使用最小的大小。必须安装`audit`守护程序，并且为了具有要分析和理解的审计系统日志，最好安装Apache和MySQL/MariaDB服务器。
- en: 'Here is an example in CentOS:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是CentOS的一个示例：
- en: '[PRE0]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '`auditd` gives in-depth details about your server performance and activity
    by using audit rules that can be modified based on your needs. To install `audit`
    daemon, use the following:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: '`auditd`通过使用可以根据您的需求进行修改的审计规则，提供关于服务器性能和活动的深入详细信息。要安装`audit`守护程序，请使用以下命令：'
- en: '[PRE1]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'On executing the preceding command, you''ll get the following output:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 执行上述命令后，您将获得以下输出：
- en: '![Installing the audit daemon](img/B15455_11_01.jpg)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![安装审计守护程序](img/B15455_11_01.jpg)'
- en: 'Figure 11.1: Installing the audit daemon'
  id: totrans-16
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.1：安装审计守护程序
- en: 'If you can see the list of installed audit packages as shown previously, then
    it''s installed already; if not, then run the following command:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您可以看到如前所示的已安装的审计软件包列表，则已经安装了；如果没有，则运行以下命令：
- en: '[PRE2]'
  id: totrans-18
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'After installing `auditd` successfully, you need to start the `auditd` service
    to start collecting audit logs and then store the logs:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 成功安装`auditd`后，您需要启动`auditd`服务以开始收集审计日志，然后存储日志：
- en: '[PRE3]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'If you want to start `auditd` at boot time, then you have to use the following
    command:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想在启动时启动`auditd`，那么您必须使用以下命令：
- en: '[PRE4]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Now let''s verify whether `auditd` is successfully installed and has started
    collecting logs using the following command:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们验证`auditd`是否已成功安装并开始使用以下命令收集日志：
- en: '[PRE5]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '![Verifying of an installation of auditd and collection of logs](img/B15455_11_02.jpg)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![验证auditd的安装和日志收集](img/B15455_11_02.jpg)'
- en: 'Figure 11.2: Verifying the successful installation of auditd and collection
    of logs'
  id: totrans-26
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.2：验证成功安装auditd并收集日志
- en: In this chapter, we will cover general Azure management and Azure Monitor. The
    Log Analytics agent for Linux, which is needed to collect information from the
    VM, is not supported in every Linux distribution; please visit [https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux](https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux)
    before making a decision about which distribution you want to use in this chapter.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖一般的Azure管理和Azure Monitor。Linux的Log Analytics代理，用于从VM收集信息，不受每个Linux发行版的支持；在决定要在本章中使用哪个发行版之前，请访问[https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux](https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux)。
- en: Note
  id: totrans-28
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: '**Operations Management Suite** (**OMS**) in general was retired and transitioned
    to Azure and the name ''''OMS'''' is not used anywhere anymore, except in some
    variable names. It is now known as Azure Monitor. For more information on naming
    and terminology changes, please refer to [https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology](https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology),
    or you can also get detailed information about the transition at [https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition).'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: '**运营管理套件**（**OMS**）通常已停用，并过渡到Azure，名称“OMS”不再在任何地方使用，除了一些变量名称。现在它被称为Azure Monitor。有关命名和术语更改的更多信息，请参阅[https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology](https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology)，或者您也可以在[https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition)获取有关过渡的详细信息。'
- en: Accessing Your System
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 访问您的系统
- en: Learning to troubleshoot your workloads will help you in your daily job. Troubleshooting
    in Azure is not different from doing so in other environments. In this section,
    we are going to see some tips and tricks that will help you in your daily job.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 学会排除工作负载将有助于您的日常工作。在Azure中进行故障排除与在其他环境中进行故障排除并无不同。在本节中，我们将看到一些技巧和窍门，这些将有助于您的日常工作。
- en: No Remote Access
  id: totrans-32
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 无远程访问
- en: When you don't have access to your Azure VM via SSH, you can run commands via
    the Azure portal.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 当您无法通过SSH访问Azure VM时，可以通过Azure门户运行命令。
- en: 'To run a command on your Azure VM from the Azure portal, log in to your Azure
    portal, navigate to your VM and select **Run Command**:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 要在Azure门户上的Azure VM上运行命令，请登录到Azure门户，导航到您的VM并选择**运行命令**：
- en: '![A list of commands to navigate to the VM section within the Azure portal](img/B15455_11_03.jpg)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
  zh: '![导航到Azure门户中的VM部分的命令列表](img/B15455_11_03.jpg)'
- en: 'Figure 11.3: Navigating to the VM section within the Azure portal'
  id: totrans-36
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.3：导航到Azure门户中的VM部分
- en: 'Alternatively, you can use the command line, as follows:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以使用命令行，如下所示：
- en: '[PRE6]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The `az vm run` command can be used to run shell scripts in your VM for general
    machine or application management and to diagnose issues.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: '`az vm run`命令可用于在VM中运行shell脚本，用于一般机器或应用程序管理以及诊断问题。'
- en: Whether you are doing it via the command line or via the Azure portal, the `az
    vm` command only works if the Microsoft Azure Linux agent is still running and
    reachable.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 无论是通过命令行还是通过Azure门户，只有在Microsoft Azure Linux代理仍在运行并可访问时，`az vm`命令才能正常工作。
- en: Note
  id: totrans-41
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: You can get the latest Microsoft Azure PowerShell repository at [https://github.com/Azure/azure-powershell](https://github.com/Azure/azure-powershell),
    which has the installation steps and its usage. `az` is replacing AzureRM and
    all the new Azure PowerShell features will be available only in `az` going forward.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在[https://github.com/Azure/azure-powershell](https://github.com/Azure/azure-powershell)获取最新的Microsoft
    Azure PowerShell存储库，其中包含安装步骤及其用法。`az`正在取代AzureRM，所有新的Azure PowerShell功能将只在`az`中提供。
- en: 'As per the security best practice, you need to change the password by logging
    in to your Azure account and using `az vm user` to reset the password as follows:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 根据安全最佳实践，您需要通过登录到Azure帐户并使用`az vm user`来重置密码来更改密码如下：
- en: '[PRE7]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'This only works if you have a user that is configured with a password. If you
    deployed your VM with SSH keys, then you are lucky: the **Reset password** option
    in the same section will do the job.'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 只有当您配置了具有密码的用户时才有效。如果您使用SSH密钥部署了VM，那么您很幸运：同一部分中的**重置密码**选项将完成工作。
- en: This option uses the VMAccess extension ([https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess](https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess)).
    Like the **Run command** option discussed earlier, it needs the Azure VM Agent.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项使用VMAccess扩展（[https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess](https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess)）。与前面讨论的**运行命令**选项一样，它需要Azure
    VM代理。
- en: Working on the Port
  id: totrans-47
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 处理端口
- en: The reason that you don't have remote access may be network-related. In *Chapter
    5*, *Advanced Linux Administration*, the `ip` command was briefly introduced in
    the *Networking* section. You can use this command to verify the IP address and
    the route table.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 您无法远程访问的原因可能与网络有关。在*第5章*，*高级Linux管理*中，`ip`命令在*网络*部分中被简要介绍。您可以使用此命令验证IP地址和路由表。
- en: 'On the Azure site, the network and the network security groups must be checked,
    as covered in *Chapter 3*, *Basic Linux Administration*. In the VM, you can use
    the `ss` command, such as `ip`, which is a part of the `iproute2` package to list
    the UPD (`-u`) and TCP (`p`) ports in a listening state, together with the process
    ID (`-p`) that opened the port:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure站点上，必须检查网络和网络安全组，如*第3章*，*基本Linux管理*中所述。在VM中，您可以使用`ss`命令，例如`ip`，它是`iproute2`软件包的一部分，用于列出处于监听状态的UPD（`-u`）和TCP（`p`）端口，以及打开端口的进程ID（`-p`）：
- en: '![Using the ss -tulpn command to check the ports details](img/B15455_11_04.jpg)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
  zh: '![使用ss -tulpn命令检查端口详细信息](img/B15455_11_04.jpg)'
- en: 'Figure 11.4: Using the ss -tulpn command to check the ports'
  id: totrans-51
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.4：使用ss -tulpn命令检查端口
- en: 'A quick check on the firewall rules can be done with `firewall-cmd --list-all
    --zone=public`; if you have multiple zones and interfaces, you need to execute
    this for every zone. To include the rules created by Azure Service Fabric, `iptables-save`
    can help:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用`firewall-cmd --list-all --zone=public`快速检查防火墙规则；如果有多个区域和接口，您需要为每个区域执行此操作。要包括Azure
    Service Fabric创建的规则，可以使用`iptables-save`：
- en: '![iptables-save command to include the rules created by Azure Service Fabric](img/B15455_11_05.jpg)'
  id: totrans-53
  prefs: []
  type: TYPE_IMG
  zh: '![使用iptables-save命令包括Azure Service Fabric创建的规则](img/B15455_11_05.jpg)'
- en: 'Figure 11.5: Including the rules created by Azure Service Fabric'
  id: totrans-54
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.5：包括Azure Service Fabric创建的规则
- en: Unfortunately, there is no comment available to see all the access rules configured
    at the `systemd` unit level. Don't forget to verify them, as discussed in *Chapter
    6*, *Managing Linux Security and Identities*.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，在`systemd`单元级别没有可用的注释来查看所有访问规则的配置。不要忘记验证它们，如*第6章*，*管理Linux安全和身份*中所讨论的那样。
- en: Using nftables
  id: totrans-56
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用nftables
- en: '`nftables` is easier to use than `iptables` and it combines the whole `iptables`
    framework with a simple syntax. `nftables` is built on a kernel `netfilter` subsystem
    that can be used to create grouped, complex filtering rules. nftables has many
    advantages over `iptables`. For instance, it allows you to perform multiple actions
    using a single rule. It uses the `nft` command-line tool, which can be used in
    interactive mode as well by using the `nft -i` command:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '`nftables`比`iptables`更容易使用，并且它将整个`iptables`框架与简单的语法结合在一起。`nftables`建立在一个内核`netfilter`子系统上，可用于创建分组的复杂过滤规则。nftables比`iptables`具有许多优点。例如，它允许您使用单个规则执行多个操作。它使用`nft`命令行工具，也可以使用`nft
    -i`命令以交互模式使用：'
- en: 'Install `nftables` using the following command:'
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令安装`nftables`：
- en: '[PRE8]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Then install `compat`, which loads the compatibility with the `nftables` kernel
    subsystem:'
  id: totrans-60
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后安装`compat`，加载与`nftables`内核子系统的兼容性：
- en: '[PRE9]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Finally, enable the `nftables` service using the following command:'
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，使用以下命令启用`nftables`服务：
- en: '[PRE10]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'You can view the current `nft` configuration using this:'
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以使用以下命令查看当前的`nft`配置：
- en: '[PRE11]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Also, you can log into `nft` interactive mode using the following command:'
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此外，您可以使用以下命令登录到`nft`交互模式：
- en: '[PRE12]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Now you can list the existing ruleset by using the following `list` command:'
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，您可以使用以下`list`命令列出现有的规则集：
- en: '[PRE13]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Let''s create a new table, `rule_table1`:'
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们创建一个新表，`rule_table1`：
- en: '[PRE14]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Now we will need to add the chain command to accept inbound/outbound traffic
    as follows:'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，我们需要添加接受入站/出站流量的链命令如下：
- en: '[PRE15]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'You can use the following command to add rules to accept TCP (Transmission
    Control Protocol) ports:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以使用以下命令添加规则以接受TCP（传输控制协议）端口：
- en: '[PRE16]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Here is the output of our new `nftables` configuration:'
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这是我们新的`nftables`配置的输出：
- en: '[PRE17]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Boot Diagnostics
  id: totrans-78
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 引导诊断
- en: Let's say you've created your VM, probably orchestrated, and most likely it's
    your own VM, but it doesn't boot.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 假设您已经创建了您的VM，可能是经过编排的，并且很可能是您自己的VM，但它无法启动。
- en: Before enabling the boot diagnostics on your VMs, you'll need a storage account
    to be able to store the data. You can list the storage accounts that are already
    available with the `az storage account list` and, if needed, you can create one
    with the `az storage account create` command.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 在启用 VM 的引导诊断之前，您需要一个存储账户来存储数据。您可以使用 `az storage account list` 列出已经可用的存储账户，如果需要，可以使用
    `az storage account create` 命令创建一个存储账户。
- en: 'Now let''s enable the boot diagnostics by entering the following command in
    the Azure CLI:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们通过在 Azure CLI 中输入以下命令来启用引导诊断：
- en: '[PRE18]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: The difference is that you don't need the name of the storage account, but the
    name of the storage blob, which can be found with the `az storage account list`
    command as a property of the storage account.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 区别在于您不需要存储账户的名称，而是需要存储 blob 的名称，可以通过 `az storage account list` 命令作为存储账户的属性找到。
- en: 'Execute the following in the Azure CLI to receive the boot log:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure CLI 中执行以下命令以接收引导日志：
- en: '[PRE19]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: The output is also automatically stored in a file; in the Azure CLI, it's a
    good idea to pipe it through `less` or redirect it to a file.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 输出也会自动存储在一个文件中；在 Azure CLI 中，最好通过 `less` 进行管道处理或将其重定向到文件中。
- en: Logging in Linux
  id: totrans-87
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Linux 日志
- en: Many processes, services, and applications run on typical Linux systems, which
    produce different logs, such as application, event, service, and system logs,
    that can be used for auditing and troubleshooting. In earlier chapters, we encountered
    the `journalctl` command, which is used for querying and displaying logs. In this
    chapter, we'll discuss this command in much more detail and look at how you can
    slice and dice your logs using the `journalctl` utility.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 典型的 Linux 系统上运行着许多进程、服务和应用程序，它们产生不同的日志，如应用程序、事件、服务和系统日志，可用于审计和故障排除。在早期的章节中，我们遇到了
    `journalctl` 命令，用于查询和显示日志。在本章中，我们将更详细地讨论这个命令，并看看如何使用 `journalctl` 实用程序来切割和处理日志。
- en: In Linux distributions, such as the latest versions of RHEL/CentOS, Debian,
    Ubuntu, and SUSE, which use systemd as their `init` system, the `systemd-journald`
    daemon is used for logging. This daemon collects the standard output of a unit,
    a syslog message, and (if the application supports it) directs messages from the
    application to systemd.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用 systemd 作为其 `init` 系统的 Linux 发行版中，如 RHEL/CentOS、Debian、Ubuntu 和 SUSE 的最新版本中，使用
    `systemd-journald` 守护程序进行日志记录。该守护程序收集单元的标准输出、syslog 消息，并且（如果应用程序支持）将应用程序的消息传递给
    systemd。
- en: The logs are collected in a database that can be queried with `journalctl`.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 日志被收集在一个数据库中，可以使用 `journalctl` 进行查询。
- en: '**Working with journalctl**'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: '**使用 journalctl**'
- en: 'If you execute `systemctl status <unit>`, you can see the last entries of the
    log. To see the full log, `journalctl` is the tool that you need. There is a difference
    with `systemctl`: you can view the status on other hosts using the `-H` parameter.
    You can''t use `journalctl` to connect to other hosts. Both utilities have the
    `–M` parameter to connect to the `systemd-nspawn` and `Rkt` containers.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您执行 `systemctl status <unit>`，您可以看到日志的最后条目。要查看完整的日志，`journalctl` 是您需要的工具。与
    `systemctl` 不同的是：您可以使用 `-H` 参数在其他主机上查看状态。您不能使用 `journalctl` 连接到其他主机。这两个实用程序都有
    `–M` 参数，用于连接到 `systemd-nspawn` 和 `Rkt` 容器。
- en: 'To view the entries in the journal database, execute this:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看日志数据库中的条目，请执行以下操作：
- en: '[PRE20]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '![Viewing the entries in the journal database using journalctl --unit <unit>
    command](img/B15455_11_06.jpg)'
  id: totrans-95
  prefs: []
  type: TYPE_IMG
  zh: '![使用 journalctl --unit <unit> 命令查看日志数据库中的条目](img/B15455_11_06.jpg)'
- en: 'Figure 11.6: Viewing the entries in the journal database'
  id: totrans-96
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 11.6：查看日志数据库中的条目
- en: 'By default, the log is paged with `less`. If you want another pager, such as
    `more`, then you can configure it via the `/etc/environment` file. Add the following
    line:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，日志使用 `less` 进行分页。如果您想要另一个分页器，比如 `more`，那么您可以通过 `/etc/environment` 文件进行配置。添加以下行：
- en: '[PRE21]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Here is an example of the output:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是输出的示例：
- en: '![Using the journalctl command to get the log entries of the processes](img/B15455_11_07.jpg)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
  zh: '![使用 journalctl 命令获取进程的日志条目](img/B15455_11_07.jpg)'
- en: 'Figure 11.7: Using the journalctl command to get the log entries of the processes'
  id: totrans-101
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 11.7：使用 journalctl 命令获取进程的日志条目
- en: 'Let''s examine the output:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们来看一下输出：
- en: 'The first column is the timestamp. In the database, it''s defined in EPOCH
    time, so if you change your time zone, no problem: it will be translated.'
  id: totrans-103
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第一列是时间戳。在数据库中，它是以 EPOCH 时间定义的，因此如果您更改时区，没有问题：它会被转换。
- en: The second column is the hostname, as shown by the `hostnamectl` command.
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第二列是主机名，由 `hostnamectl` 命令显示。
- en: The third column contains an identifier and the process ID.
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第三列包含标识符和进程 ID。
- en: The fourth column is the message.
  id: totrans-106
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第四列是消息。
- en: 'You can add the following parameters to filter the logs:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以添加以下参数来过滤日志：
- en: '`--dmesg`: Kernel messages, a replacement for the old `dmesg` command'
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--dmesg`：内核消息，替代了旧的 `dmesg` 命令'
- en: '`--identifier`: Identifier string'
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--identifier`：标识符字符串'
- en: '`--boot`: Messages during the current boot process; you can also select previous
    boots if the database is persistent across reboots'
  id: totrans-110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--boot`：当前引导过程中的消息；如果数据库在重启后是持久的，还可以选择以前的引导'
- en: '**Filters**'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: '**过滤器**'
- en: 'Of course, you can `grep` on the standard output, but `journalctl` has some
    parameters that really help to filter out the information you want:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，您可以在标准输出上使用 `grep`，但 `journalctl` 有一些参数，可以帮助您过滤出所需的信息：
- en: '`--priority`: Filter on `alert`, `crit`, `debug`, `emerg`, `err`, `info`, `notice`,
    and `warning`. The classification of these priorities is the same as in the syslog
    protocol specification.'
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--priority`：按 `alert`、`crit`、`debug`、`emerg`、`err`、`info`、`notice` 和 `warning`
    进行过滤。这些优先级的分类与 syslog 协议规范中的相同。'
- en: '`--since` and `--until`: Filter on timestamp. Refer to `man systemd.time` to
    see all the possibilities.'
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--since` 和 `--until`：按时间戳过滤。参考 `man systemd.time` 查看所有可能性。'
- en: '`--lines`: Number of lines, similar to `tail`.'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--lines`：行数，类似于 `tail`。'
- en: '`--follow`: Similar behavior to `tail -f`.'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--follow`：类似于 `tail -f` 的行为。'
- en: '`--reverse`: Puts the last line first.'
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--reverse`：将最后一行放在第一行。'
- en: '`--output`: Changes the output format to formats such as JSON, or adds more
    verbosity to the output.'
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--output`：将输出格式更改为JSON等格式，或者向输出添加更多详细信息。'
- en: '`--catalog`: Adds an explanation of the message if one is available.'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--catalog`：如果有消息的解释，则添加消息的解释。'
- en: 'All the filters can be combined, as here:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 所有过滤器都可以组合，就像这里一样：
- en: '[PRE22]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: '![Filtering the log entries by using multiple parameters with journalctl](img/B15455_11_08.jpg)'
  id: totrans-122
  prefs: []
  type: TYPE_IMG
  zh: '![使用journalctl使用多个参数过滤日志条目](img/B15455_11_08.jpg)'
- en: 'Figure 11.8: Filtering the log entries by using multiple filters with journalctl'
  id: totrans-123
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.8：使用journalctl使用多个过滤器过滤日志条目
- en: '**Filtering Based on Fields**'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: '**基于字段的过滤**'
- en: 'We can also filter on fields. Type this:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还可以根据字段进行过滤。键入此命令：
- en: '[PRE23]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Now press *Ctrl* + *I* twice; you''ll see all the available fields. The same
    principle applies to these filters; that is, you can combine them:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 现在按两次*Ctrl* + *I*；您将看到所有可用字段。这些过滤器也适用于相同的原则；也就是说，您可以将它们组合起来：
- en: '[PRE24]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'You can even combine them with normal filters:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 您甚至可以将它们与普通过滤器组合使用：
- en: '[PRE25]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: '**Database Persistence**'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '**数据库持久性**'
- en: Now you may need to store the logs for a certain period of time for compliance
    reasons or audit requirements. So, you can use an Azure Log Analytics agent to
    collect logs from different sources. By default, the logging database is not persistent.
    To make it persistent, for any audit- or compliance-related reason (though it
    is not a best practice to store the logs in localhost), you have to edit the configuration
    file, `/etc/systemd/journald.conf`.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您可能需要出于合规原因或审计要求存储日志一段时间。因此，您可以使用Azure Log Analytics代理从不同来源收集日志。默认情况下，日志数据库不是持久的。为了使其持久化，出于审计或合规原因（尽管最佳做法不是将日志存储在本地主机），您必须编辑配置文件`/etc/systemd/journald.conf`。
- en: 'Change the `#Storage=auto` line to this:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 将`#Storage=auto`行更改为此：
- en: '[PRE26]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Restart the `systemd-journald` daemon with `force`:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`force`重新启动`systemd-journald`守护程序：
- en: '[PRE27]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Use this to view the recorded boots:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此查看记录的引导：
- en: '[PRE28]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: '![Viewing the recorded boots using --list-boots command](img/B15455_11_09.jpg)'
  id: totrans-139
  prefs: []
  type: TYPE_IMG
  zh: '![使用--list-boots命令查看记录的引导](img/B15455_11_09.jpg)'
- en: 'Figure 11.9: Viewing the recorded boots'
  id: totrans-140
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.9：查看记录的引导
- en: 'You can add the boot ID as a filter using the `--boot` parameter:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用`--boot`参数将引导ID作为过滤器添加：
- en: '[PRE29]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: By this means, the output of `hostnamectl` shows the current boot ID.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 通过这种方式，`hostnamectl`的输出显示当前的引导ID。
- en: The journal database is not dependent on the daemon. You can view it using the
    `--directory` and `--file` parameters.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 日志数据库不依赖于守护程序。您可以使用`--directory`和`--file`参数查看它。
- en: '**Syslog Protocol**'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: '**Syslog协议**'
- en: Logging in Linux and other members of the Unix family was enabled during the
    implementation of the syslog protocol. It is still used to send logging to remote
    services.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 在实施syslog协议期间，Linux和Unix家族的其他成员启用了日志记录。它仍然用于将日志发送到远程服务。
- en: It is important to understand that this protocol uses facilities and severity.
    Both are standardized in RFC 5424 ([https://tools.ietf.org/html/rfc5424](https://tools.ietf.org/html/rfc5424)).
    Here, a facility specifies the type of program that is logging the message; for
    instance, the kernel or cron. The severity label is there to describe the impact,
    such as informational or critical.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 重要的是要理解该协议使用设施和严重性。这两者在RFC 5424（[https://tools.ietf.org/html/rfc5424](https://tools.ietf.org/html/rfc5424)）中标准化。在这里，设施指定记录消息的程序类型；例如，内核或cron。严重性标签用于描述影响，例如信息或关键。
- en: The programmers' man page for syslog (`journald` is able to get everything regarding
    the output of a program.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 程序员的syslog手册（`journald`能够获取有关程序输出的所有内容。
- en: '**Adding Log Entries**'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: '**添加日志条目**'
- en: 'You can manually add entries to a log. For syslog, the `logger` command is
    available:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以手动向日志添加条目。对于syslog，`logger`命令可用：
- en: '[PRE30]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'For `journald`, there is `systemd-cat`:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 对于`journald`，有`systemd-cat`：
- en: '[PRE31]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Let''s look at an example:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看一个例子：
- en: '[PRE32]'
  id: totrans-155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'As an identifier, you can use free strings or syslog facilities. Both `logger`
    and `systemd-cat` can be used to generate entries in your log. You can use this
    if the application doesn''t have syslog support; for instance, in an Apache configuration,
    you can use this directive:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 作为标识符，您可以使用自由字符串或syslog设施。`logger`和`systemd-cat`都可以用于在日志中生成条目。如果应用程序不支持syslog，则可以使用此功能；例如，在Apache配置中，您可以使用此指令：
- en: '[PRE33]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: You can also use this as a part of change management.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以将其作为变更管理的一部分使用。
- en: '**Integrating journald with RSYSLOG**'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: '**将journald与RSYSLOG集成**'
- en: 'To collect your data for your own monitoring service, your monitoring service
    needs syslog support. Good examples of these monitoring services are available
    as a ready-to-go VM in Azure: **Splunk** and the **Elastic Stack**.'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 为了为您自己的监控服务收集数据，您的监控服务需要syslog支持。这些监控服务的良好示例作为Azure中的现成VM提供：**Splunk**和**Elastic
    Stack**。
- en: RSYSLOG is the most commonly used syslog protocol implementation nowadays. It's
    already installed by default in Ubuntu-, SUSE-, and Red Hat–based distributions.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: RSYSLOG是当今最常用的syslog协议实现。它已经默认安装在Ubuntu、SUSE和Red Hat等发行版中。
- en: 'RSYSLOG can work very well together with the journal database using the `imjournal`
    module. In SUSE- and Red Hat–based distributions, this is already configured;
    in Ubuntu, you have to make a modification to the `/etc/rsyslog.conf` file:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: RSYSLOG可以使用`imjournal`模块与日志数据库很好地配合。在SUSE和Red Hat等发行版中，这已经配置好；在Ubuntu中，您必须对`/etc/rsyslog.conf`文件进行修改：
- en: '[PRE34]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'After the modification, restart RSYSLOG:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 修改后，重新启动RSYSLOG：
- en: '[PRE35]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Using the settings in `/etc/rsyslog.d/50-default.conf`, it logs to plain text
    files.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`/etc/rsyslog.d/50-default.conf`中的设置，它记录到纯文本文件中。
- en: 'To send everything coming from the local syslog to a remote syslog server,
    you have to add the following to this file:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 要将来自本地syslog的所有内容发送到远程syslog服务器，您必须将以下内容添加到此文件中：
- en: '[PRE36]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: Note
  id: totrans-169
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: This is the name of the file in Ubuntu. In other distributions, use `/etc/rsyslog.conf`.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 这是Ubuntu中的文件名。在其他发行版中，请使用`/etc/rsyslog.conf`。
- en: Use `@@` if you want TCP instead of the UDP protocol.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 如果要使用TCP协议而不是UDP协议，请使用`@@`。
- en: '**Other Log Files**'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: '**其他日志文件**'
- en: You can find log files of applications that don't support syslog or `systemd-journald`
    in the `/var/log` directory structure. One important file to notice is the `/var/log/waagent.log`
    file, which contains the logging from the Azure Linux VM agent. There is also
    the `/var/log/azure` directory, which contains logging from other Azure agents
    (such as Azure Monitor) and VM extensions.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
- en: Azure Log Analytics
  id: totrans-174
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Azure Log Analytics is a part of Azure Monitor that collects and analyzes log
    data and takes the appropriate actions. It is a service in Azure that collects
    log data from multiple systems in a single data store in a central place. It consists
    of two important components:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: The Azure Log Analytics portal, with alerts, reports, and analysis features
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The Azure Monitor agent, which needs to be installed on a VM
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: There is also a mobile app available (in the iOS and Android store, you can
    find it under the name *Microsoft Azure*) if you want to view the state of your
    workloads while you are on the go.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
- en: Configuring the Log Analytics Service
  id: totrans-179
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In the Azure portal, select **All Services** from the left-hand bar and search
    for **Log Analytics**. Select **Add** and create a new Log Analytics workspace.
    At the time of writing, it is not available in all regions. Using the service
    is not limited to the region; if a VM is in another region, you can still monitor
    it.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-181
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: There is no upfront cost for this service and you pay for what you use! Read
    [http://aka.ms/PricingTierWarning](http://aka.ms/PricingTierWarning) for more
    details.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: 'Another way to create the service is with the Azure CLI:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: After the creation of the service, there is a pop-up that allows you to navigate
    to the newly created resource. Alternatively, you can search again in **All Services**.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: Please note, at the top-right of the resource pane, Azure Monitor and the workspace
    ID; you'll need this information later on. Navigate to **Advanced settings** to
    find the workspace key.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
- en: 'In the Azure CLI, you can collect this information using the following:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'To list all the workspaces of your Azure subscription, you can use the following
    Azure CLI command:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'You can get detailed information about a workspace in JSON format using the
    following Azure CLI command:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: Installing the Azure Log Analytics Agent
  id: totrans-193
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Before installing the Azure Monitor agent, make sure that the `audit` package
    (in `auditd`) is installed.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: 'To install the Azure Monitor agent in a Linux VM, you have two possibilities:
    enable the VM extension `OMSAgentforLinux`, or download and install the Log Analytics
    Agent in Linux.'
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
- en: 'First, set some variables to make the scripting easier:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'You need the workspace ID and key. The `Set-AzureVMExtension` cmdlet needs
    the keys in JSON format, so a conversion is needed:'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'Now you can add the extension to the VM:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'The previous procedure is pretty complex and takes a while. The download method
    is easier, but you have to log in to your VM via SSH as a guest. Of course, both
    methods can be automated/orchestrated:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: If you have problems during the installation of the agent, look in the `/var/log/waagent.log`
    and `/var/log/azure/Microsoft.EnterpriseCloud.Monitoring.OmsAgentForLinux/*/extension.log`
    configuration files.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
- en: 'The installation of the extensions also creates a configuration file for `rsyslog,/etc/rsyslogd.d/95-omsagent.conf`:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: It basically means that the syslog messages (`facility.priority`) are sent to
    the Azure Monitor agent.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
- en: 'At the bottom pane of the new resource, there is a section entitled **Get started
    with Log Analytics**:'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
- en: '![Get started with Log Analytics section in Azure Portal](img/B15455_11_10.jpg)'
  id: totrans-209
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.10: Get started with Log Analytics section in Azure Portal'
  id: totrans-210
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Click on **Azure virtual machines (VMs)**. You''ll see the VMs that are available
    in this workspace:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
- en: '![Available VMs in the workspace](img/B15455_11_11.jpg)'
  id: totrans-212
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.11: Available VMs in the workspace'
  id: totrans-213
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: The preceding screenshot represents the available VMs in the workspace. It also
    shows that we have connected to the data source.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
- en: Getting the Data
  id: totrans-215
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In the **Advanced settings** section of this resource, you can add performance
    and syslog data sources. You can access all the data via the log search using
    a special query language. If you are new to this language, you should visit [https://docs.loganalytics.io/docs/Learn/Getting-Started/Getting-started-with-queries](https://docs.loganalytics.io/docs/Learn/Getting-Started/Getting-started-with-queries)
    and [https://docs.loganalytics.io/index](https://docs.loganalytics.io/index).
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
- en: 'For now, just execute this query:'
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'To see whether there is data available, limit the search to one VM:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'Alternatively, to get all the syslog messages, as a test, you can reboot your
    VM, or play with this:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  id: totrans-222
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'Execute the following query in syslog to view the results:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: There are also many examples available if you click on the **Saved searches**
    button.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
- en: 'Monitoring solutions provide a very interesting add-on to make this process
    even easier. In the **Resource** pane, click on **View solutions**:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
- en: '![Navigating to the View solutions option in VM](img/B15455_11_12.jpg)'
  id: totrans-227
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.12: Navigating to the monitoring solutions option'
  id: totrans-228
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Select the desired option and click on **Add**:'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
- en: '![Management Solutions within Log Analytics](img/B15455_11_13.jpg)'
  id: totrans-230
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.13: Management Solutions within Log Analytics'
  id: totrans-231
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: '**Service Map** is an important service. It gives a great overview of your
    resources and provides an easy interface for logs, performance counters, and so
    on. After installing **Service Map**, you have to install an agent in the Linux
    machine, or you can log in to the portal and navigate to the VM, which will install
    the agent automatically for you:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: After the installation, select **Virtual Machines** > **Monitoring** > **Insights**
    > **Service Map**.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, click on **Summary**:'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
- en: '![The Summary section in Service Map](img/B15455_11_14.jpg)'
  id: totrans-236
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.14: The Summary section of the Service Map'
  id: totrans-237
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'You can monitor your applications, view the log files, and so on:'
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
- en: '![Check log files to moniter the application](img/B15455_11_15.jpg)'
  id: totrans-239
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.15: Service Map overview'
  id: totrans-240
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Log Analytics and Kubernetes
  id: totrans-241
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In order to manage your containers, you need detailed insights into CPU, memory,
    storage, and network usage and performance information. Azure Monitor can be used
    to view Kubernetes logs, events, and metrics, allowing for container monitoring
    from a single location. You can enable Azure Monitor for containers for your new
    or existing AKS deployments using the Azure CLI, Azure PowerShell, the Azure portal,
    or Terraform.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
- en: 'To create a new `az aks create` command:'
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  id: totrans-244
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'To enable Azure Monitor for your existing AKS cluster, use the `az aks` command
    with this modification:'
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  id: totrans-246
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'You can enable monitoring for your AKS cluster from the Azure portal by selecting
    **Monitor** and then selecting **Containers**. Here, select the **Non-monitored
    clusters**, then choose the container and click **Enable**:'
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
- en: '![Monitoring AKS cluster from the Azure portal](img/B15455_11_16.jpg)'
  id: totrans-248
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.16: Monitoring AKS cluster from the Azure portal'
  id: totrans-249
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Log Analytics for Your Network
  id: totrans-250
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Another solution in Azure Log Analytics is Traffic Analytics. It visualizes
    network traffic to and from your workloads, including open ports. It is able to
    generate alerts for security threats, for instance, if an application tries to
    reach a network that it's not allowed to access. Also, it provides detailed monitoring
    options with log export options.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
- en: 'If you want to use Traffic Analytics, first you have to create a network watcher
    for every region you want to analyze:'
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  id: totrans-253
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'After that, you have to reregister the network provider and add Microsoft Insights
    so the network watcher can hook into it:'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  id: totrans-255
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: You can't use this solution with other providers, such as `Microsoft.ClassicNetwork`.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
- en: The next step involves using **network security group** **(NSG)**, which controls
    the flow of logging by allowing or denying the incoming traffic. At the time of
    writing, this is only possible using the Azure portal. In the left-hand bar of
    the Azure portal, select **Monitor**>**Network watcher** and then select **NSG
    flow logs**. Now you are able to select the NSG that you want to enable an **NSG
    flow log** for.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
- en: Enable it, select a storage account, and select your Log Analytics workspace.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
- en: 'It will take some time before the information comes in and is collected. After
    about 30 minutes, the first information should be visible. Select **Monitor**
    in the left-hand bar of the Azure portal, go to **Network watcher**, and then
    **Traffic Analytics**. Alternatively, start from your Log Analytics workspace:'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
- en: '![Checking Traffic Analytics tab from the Azure portal to view the network
    traffic flow distribution](img/B15455_11_17.jpg)'
  id: totrans-260
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.17: Viewing the network traffic flow distribution with Traffic Analytics'
  id: totrans-261
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Performance Monitoring
  id: totrans-262
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In Azure Monitor, there are many options available for monitoring. For instance,
    performance counters give you a lot of insight into your workload. There are also
    application-specific options.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
- en: 'Even if you don''t use Azure Monitor, Azure can provide all kinds of metrics
    for each VM, but not in one central place. Just navigate to your VM. In the **Overview**
    pane, you can see performance data for CPU, memory, and storage. Detailed information
    is available in the **Metrics** section, under **Monitoring**. All kinds of data
    are available, such as CPU, storage, and networking data:'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Overview pane the Azure portal to view the performance data for the
    VM](img/B15455_11_18.jpg)'
  id: totrans-265
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.18: Viewing the performance data of the VM'
  id: totrans-266
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: The problem with many of these solutions is that they are application-specific,
    or you are looking at the end result without knowing what the cause is. If you
    need information about the general performance of the resources utilized by the
    virtual machine(s), use the information provided by Azure. If you need information
    on the web server or database you're running, look and see whether there is an
    Azure solution. But in many scenarios, it is very helpful if you can do performance
    troubleshooting in the VM as well. In a way, we're going to start where the *Process
    management* section in *Chapter 3*, *Basic Linux Administration*, left off.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
- en: Before we start, there are multiple methods and ways of doing performance troubleshooting.
    Can this book provide the only method you should use, or tell you the one tool
    you'll need? No, unfortunately not! But what it can do is make you aware of the
    tools that are available and cover at least their basic usage. For more specific
    needs, you can always dive into the man pages. In this section, we're especially
    looking into what the load is and what is causing it.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
- en: 'And one last thing: this section is called *Performance monitoring*, but that
    may not be the perfect title. It''s balancing monitoring, troubleshooting, and
    analysis. However, isn''t that often the case in the daily life of every system
    engineer?'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
- en: 'Not all the tools mentioned are available by default in the Red Hat/CentOS
    repository. You''ll need to configure the `epel` repository: `yum install epel-release`.'
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
- en: Displaying Linux processes with top
  id: totrans-271
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If you look into a topic such as performance monitoring and Linux, `top` is
    always mentioned. It is the number-one command to use to quickly get an idea of
    what is running on a system.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
- en: 'You can display many things with `top`, and it comes with a good man page explaining
    all the options. Let''s focus on the most important ones, starting at the top
    of the screen:'
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
- en: '![Displaying Linux processes with top command](img/B15455_11_19.jpg)'
  id: totrans-274
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.19: Displaying resource usage using the top command'
  id: totrans-275
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Let''s take a look at the options mentioned in the preceding screenshot:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
- en: '`wa`): If this value is continuously above 10%, this means that the underlying
    storage is slowing down the server. This parameter shows the CPU waiting time
    for I/O processes. Azure VMs use HDDs instead of SSDs, and using multiple HDDs
    in a RAID configuration can help, but it''s better to migrate to SSDs. If that
    is not enough, there are premium SSD solutions available as well.'
  id: totrans-277
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`us`): CPU utilization by applications; please note that the CPU utilization
    is totaled across all CPUs.'
  id: totrans-278
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`sy`): The amount of time the CPU spends on kernel tasks.'
  id: totrans-279
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Swap**: Memory paged out caused by having not enough memory for your applications.
    It should be zero most of the time.'
  id: totrans-280
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The bottom of the `top` screen also has some interesting columns:'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
- en: '![The bottom entries of the output obtained from the top command](img/B15455_11_20.jpg)'
  id: totrans-282
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.20: The bottom entries of the output obtained from the top command'
  id: totrans-283
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Personally, we wouldn''t advise worrying about the priority and nice values
    for now. The effect on the performance is minimal. The first interesting field
    is `VIRT` (virtual memory). This refers to the amount of memory the program can
    access at present. It includes memory shared with other applications, video memory,
    files that are read into memory by the application, and more. It also includes
    idle memory, swapped memory, and residential memory. Residential memory is memory
    that is physically in use by this process. `SHR` is the amount of memory that
    is shared between applications. This information can give you an idea of the amount
    of `swap` you should configure on your system: take the top five processes, add
    up `VIRT`, and subtract `RES` and `SHR`. It''s not perfect, but it''s a good indicator.'
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
- en: 'The **S** column in the preceding screenshot is the status of the machine:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
- en: '`D` is uninterruptible sleep, most of the time caused by waiting on storage
    or network I/O.'
  id: totrans-286
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`R` is running—consuming CPU.'
  id: totrans-287
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`S` is sleeping—waiting on I/O, no CPU usage. Waiting for a trigger by a user
    or another process.'
  id: totrans-288
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`T` is stopped by the job control signal, most of the time because the user
    pressed *Ctrl* + *Z*.'
  id: totrans-289
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`Z` is zombie—the parent process has died. It''s labeled as a zombie by the
    kernel while the kernel is busy cleaning up. On physical machines, it can also
    be an indication of failing CPUs (caused by temperature or shoddy bios); in that
    scenario, you may see many zombies. In Azure, this won''t happen. Zombies don''t
    hurt, so don''t kill them; the kernel takes care of them.'
  id: totrans-290
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Top Alternatives
  id: totrans-291
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: There are many utilities similar to `top`, such as `htop`, which looks fancier
    and is easier to configure.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
- en: Very similar but even more interesting is `atop`. It contains all the processes
    and their resource usage, even for processes that died between screen updates
    of `atop`. This comprehensive accounting is very helpful for understanding problems
    with individual short-lived processes. `atop` is also able to gather information
    about running containers, networking, and storage.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
- en: 'Another one is `nmon`, which is similar to `atop`, but is more focused on statistics
    and gives more detailed information, especially for memory and storage:'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
- en: '![Using nmon command to get Performance details of memory, CPU and storage](img/B15455_11_21.jpg)'
  id: totrans-295
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.21: Performance details of memory, CPU and storage'
  id: totrans-296
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: '`nmon` can also be used to collect data:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  id: totrans-298
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: The preceding command collects 30 rounds of information every minute in a comma-separated
    file format that is easy to parse in a spreadsheet. On the IBM's developers website,
    [http://nmon.sourceforge.net/pmwiki.php?n=Site.Nmon-Analyser](http://nmon.sourceforge.net/pmwiki.php?n=Site.Nmon-Analyser),
    you can find an Excel spreadsheet that makes this a very easy job. It even offers
    some extra data-analyzing options.
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
- en: '`glances` is also gaining a lot of popularity lately. It is Python-based and
    provides current information about the system, uptime, CPU, memory, swap, network,
    and storage (disk I/O and file):'
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the glances utility to view the performance](img/B15455_11_22.jpg)'
  id: totrans-301
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.22: Using the glances utility to view the performance'
  id: totrans-302
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: '`glances` is the most advanced alternative to `top`. It offers all the features
    of the alternatives, and, on top of that, you can use it remotely. You need to
    provide the username and password of your server to launch `glances`:'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  id: totrans-304
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'Execute the following on the client too:'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE57]'
  id: totrans-306
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: By default, port `61209` is used. If you use the `–webserver` parameter instead
    of `--server`, you don't even need a client. A complete web interface is available
    on port `61208`!
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
- en: '`glances` is able to export logs in many formats and can be queried using an
    API. Experimental support for the **SNMP** (**Simple Network Management Protocol**)
    protocol is on the way as well.'
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
- en: Sysstat – a Collection of Performance-Monitoring Tools
  id: totrans-309
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The `sysstat` package contains utilities for performance monitoring. The most
    important ones in Azure are `sar`, `iostat`, and `pidstat`. If you are also using
    Azure Files, `cifsiostat` can be very handy as well.
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
- en: '`sar` is the main utility. The main syntax is this:'
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE58]'
  id: totrans-312
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'For instance, use this command to report CPU statistics 5 times with an interval
    of 1 second:'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  id: totrans-314
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'To monitor cores `1` and `2`, use this:'
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE60]'
  id: totrans-316
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: (If you want to monitor all the cores individually, you can use the `ALL` keyword.)
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
- en: 'Here are some other important resources:'
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
- en: '`-r`: Memory'
  id: totrans-319
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-S`: Swap'
  id: totrans-320
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-d`: Disk'
  id: totrans-321
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-n <type>`: Network types, such as these:'
  id: totrans-322
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`DEV`: Displays network devices statistics'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
- en: '`EDEV`: Displays network devices failure (error) statistics'
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
- en: '`NFS`: Displays `SOCK`: Displays sockets in use for IPv4'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
- en: '`IP`: Displays IPv4 network traffic'
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
- en: '`TCP`: Displays TCPv4 network traffic'
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
- en: '`UDP`: Displays UDPv4 network traffic'
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
- en: '`ALL`: Displays all of the preceding information'
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
- en: '`pidstat` can collect CPU data from a specific process by its process ID. In
    the next screenshot, you can see that 2 samples are shown every 5 seconds. `pidstat`
    can do the same for memory and disk:'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
- en: '![Using pidstat command to get the performance on CPU data from a specific
    process](img/B15455_11_23.jpg)'
  id: totrans-331
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.23: Displaying CPU statistics using pidstat'
  id: totrans-332
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: '`iostat` is a utility, as the name suggests, that can measure I/O, but it also
    creates reports for CPU usage:'
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
- en: '![Using iostat command to get the performance statistics for I/O](img/B15455_11_24.jpg)'
  id: totrans-334
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.24: Getting the CPU and Device report and statistics using iostat'
  id: totrans-335
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: '`tps` means the number of transfers per second issued to the device. `kb_read/s`
    and `kB_wrtn/s` are the numbers of kilobytes measured during 1 second; the `avg-cpu`
    column in the preceding screenshot is the total number of statistics since the
    time of your Linux system startup.'
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
- en: During the installation of the `sysstat` package, a cron job was installed in
    the `/etc/cron.d/sysstat` file.
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-338
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: In modern Linux systems, both `systemd-timers` and the old method using `cron`
    are available. `sysstat` still uses `cron`. To check whether `cron` is available
    and running, go to `systemctl | grep cron`.
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
- en: '`cron` runs the `sa1` command every 10 minutes. It collects system activity
    and stores it in a binary database. Once a day, the `sa2` command is executed
    to generate a report. The data is stored in the `/var/log/sa` directory. You can
    query that database with `sadf`:'
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
- en: '![Using sadf command to query the database for system activity](img/B15455_11_25.jpg)'
  id: totrans-341
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.25: Querying the database with sadf for system activity'
  id: totrans-342
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'This screenshot shows the data from November 6, between `09:00:00` and `10:10:00`.
    By default, it''s displaying CPU statistics, but you can customize it using the
    same parameters as `sar`:'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  id: totrans-344
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: This displays the network stats of every network interface on November 6.
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
- en: dstat
  id: totrans-346
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '`sysstat` is available for historical reports, while `dstat` is for real-time
    reports. While `top` is the monitoring version of `ps`, it''s `dstat` that is
    the monitoring version of `sar`:'
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting real-time reports with dstat command](img/B15455_11_26.jpg)'
  id: totrans-348
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.26: Getting real-time reports with dstat'
  id: totrans-349
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'If you don''t want to see it all at once, you can use the following parameters:'
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
- en: '`c`: CPU'
  id: totrans-351
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`d`: Disk'
  id: totrans-352
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`n`: Network'
  id: totrans-353
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`g`: Paging'
  id: totrans-354
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`s`: Swap'
  id: totrans-355
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`m`: Memory'
  id: totrans-356
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Network stats with iproute2
  id: totrans-357
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Earlier in this chapter, we talked about `ip`. This command also provides an
    option to get statistics for the network interface:'
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]'
  id: totrans-359
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: '![Getting the statistics for the network interface using ip -s link show dev
    eth0 command](img/B15455_11_27.jpg)'
  id: totrans-360
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.27: Getting the statistics for the network interface'
  id: totrans-361
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'It parses information from the `/proc/net` directory. Another utility that
    can parse this information is `ss`. A simple summary can be requested with this:'
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  id: totrans-363
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: Using the `-t` parameter not only shows you the ports in a listening state but
    also the incoming and outgoing traffic on this specific interface.
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
- en: 'If you need more details, the `iproute2` package provides another utility:
    `nstat`. Using the `–d` parameter, you can even run it in interval mode:'
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting a detailed report about the ports in a listening state using nstat
    utility](img/B15455_11_28.jpg)'
  id: totrans-366
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.28: Getting a detailed report about the ports in a listening state'
  id: totrans-367
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'That''s already much more than a simple summary of `ss`. But the `iproute2`
    package has more to offer: `lnstat`.'
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
- en: 'This is the command that provides network statistics such as routing cache
    statistics:'
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE64]'
  id: totrans-370
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: '![Getting the network statistics with lnstat––d command](img/B15455_11_29.jpg)'
  id: totrans-371
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.29: Getting the network statistics with lnstat -d'
  id: totrans-372
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: This shows you everything it can display or monitor. It's pretty low-level,
    but we've solved some firewall performance-related issues using `lnstat -f/proc/net/stat/nf_conntrack`,
    while monitoring the `drops` counter.
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
- en: Network Monitoring with IPTraf-NG
  id: totrans-374
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You can get network details from tools such as `nmon`, but if you want more
    details, then IPTraf-NG is a very nice tool for a real-time console-based network
    monitoring solution. It is a console-based network-monitoring utility that collects
    all the network IP, TCP, UDP, and ICMP data and is able to break down the information
    according to the size of the TCP/UDP. A few basic filters are included as well.
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
- en: 'Everything is in a menu-driven interface, so there are no parameters that you
    have to remember:'
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
- en: '![Menu window of IPTraf-NG](img/B15455_11_30.jpg)'
  id: totrans-377
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11.30: Menu window of IPTraf-NG'
  id: totrans-378
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: tcpdump
  id: totrans-379
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Of course, `tcpdump` is not a performance-monitoring solution. This utility
    is a great tool for monitoring, capturing, and analyzing network traffic.
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
- en: 'To view network traffic on all the network interfaces, execute the following:'
  id: totrans-381
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE65]'
  id: totrans-382
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: 'For a specific interface, try this:'
  id: totrans-383
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE66]'
  id: totrans-384
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'In general, it''s a good idea not to resolve the hostnames:'
  id: totrans-385
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE67]'
  id: totrans-386
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: 'You can add different levels of verbosity by repeating the `v` parameter up
    to a maximum verbosity level of three:'
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  id: totrans-388
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: 'You can filter the traffic based on the host:'
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  id: totrans-390
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: 'Alternatively, you can filter based on the source or destination IP:'
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE70]'
  id: totrans-392
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: 'Filtering on a specific port is also possible:'
  id: totrans-393
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  id: totrans-394
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: 'All the parameters can be combined:'
  id: totrans-395
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE72]'
  id: totrans-396
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: 'The `–c` parameter was added, so only five packets were captured. You can save
    the captured data to a file:'
  id: totrans-397
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  id: totrans-398
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: 'Two parameters were added to increase the compatibility with other analyzers
    that can read the format of `tcpdump`:'
  id: totrans-399
  prefs: []
  type: TYPE_NORMAL
- en: '`-XX`: Prints the data of each packet in hex and ASCII format'
  id: totrans-400
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-x`: Adds headers to every packet'
  id: totrans-401
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To read the data with a complete timestamp in human-readable format, use this
    command:'
  id: totrans-402
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  id: totrans-403
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: Note
  id: totrans-404
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Another great network analyzer is Wireshark. It's a graphical tool that's available
    for many operating systems. This analyzer can import captured data from `tcpdump`.
    It comes with a great search filter and analyzing tools for many different network
    protocols and services.
  id: totrans-405
  prefs: []
  type: TYPE_NORMAL
- en: It makes sense to make the capture in your VM and download it to your workstation
    in order to analyze the data further in Wireshark.
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
- en: We're sure that you will now be able to achieve good performance analysis in
    a Linux system using different tools to monitor metrics such as CPU, memory, storage,
    and network details.
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-408
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this chapter, we covered several topics regarding troubleshooting, logging,
    monitoring, and even analyzing. Starting with getting access to a VM, we investigated
    logging in Linux both locally and remotely.
  id: totrans-409
  prefs: []
  type: TYPE_NORMAL
- en: There is a thin line between performance monitoring and performance troubleshooting.
    There are many, many different utilities available to find out the cause of your
    performance issues. Each has a different goal, but there is also a great deal
    of overlap. We have covered the most popular utilities in Linux and some of the
    options available.
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
- en: In the first chapter, we saw that Azure is a very open source–friendly environment
    and that Microsoft has made a great effort to make Azure an open, standard cloud
    solution with interoperability in mind. In this chapter, we saw that Microsoft
    has not only put a lot of effort into supporting Linux while deploying your application
    but also into supporting it in Azure Monitor.
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
- en: Questions
  id: totrans-412
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Why should you have at least one user with a password in a VM?
  id: totrans-413
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What is the purpose of the `systemd-journald` daemon?
  id: totrans-414
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What are syslog facilities?
  id: totrans-415
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What priorities are available in syslog?
  id: totrans-416
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How can you add entries to a log, and why should you do that?
  id: totrans-417
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What services are available to view metrics in Azure?
  id: totrans-418
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Why is `top` only useful to have a first look into performance-related problems,
    and what utility or utilities can fix that?
  id: totrans-419
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What is the difference between the `sysstat` and `dstat` utilities?
  id: totrans-420
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Why should you install Wireshark on your workstation?
  id: totrans-421
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Further Reading
  id: totrans-422
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'A big source of information is the website of Brendan D Gregg ([http://www.brendangregg.com](http://www.brendangregg.com)),
    where he shares an unbelievably long list of Linux performance documentation,
    slides, videos, and more. On top of that, there are some nice utilities! He was
    the one who taught me, in 2015, that it is important to identify a problem correctly:'
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
- en: What makes you think that there is a problem?
  id: totrans-424
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Was there a time that there wasn't a problem?
  id: totrans-425
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Has something changed recently?
  id: totrans-426
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Try to find technical descriptions, such as latency, runtime errors, and so
    on.
  id: totrans-427
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Is it only the application, or are other resources affected as well?
  id: totrans-428
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Come up with an exact description of the environment.
  id: totrans-429
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'You also have to consider the following:'
  id: totrans-430
  prefs: []
  type: TYPE_NORMAL
- en: What is causing the load (which process, IP address, and so on)?
  id: totrans-431
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Why was the load called?
  id: totrans-432
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: What resource(s) is/are used by the load?
  id: totrans-433
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Does the load change? If so, how is it changing over time?
  id: totrans-434
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Last, but not least, there's *Red Hat Enterprise Linux Troubleshooting Guide*
    by Benjamin Cane. I know, some parts of the book are outdated, as it was printed
    in 2015\. And, for sure, I definitely hope for a second edition, but, especially
    if you are new to Linux, buy this book.
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
