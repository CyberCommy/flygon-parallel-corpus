- en: Performance Improvements, Tips, and Tricks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we will focus on optimizing an application and discovering
    bottlenecks. These are some tips and tricks that can be used immediately by existing
    applications. Many of these recipes are necessary if you or your organization
    requires fully reproducible builds. They're also useful when you want to benchmark
    an application's performance. The final recipe focuses on increasing the speed
    of HTTP; however, it's always important to remember that the web world moves quickly,
    and it's important to refresh yourself on the best practices. For example, if
    you require HTTP/2, it has been available using the built-in Go `net/http` package
    since version 1.6.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following recipes:'
  prefs: []
  type: TYPE_NORMAL
- en: Using the pprof tool
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Benchmarking and finding bottlenecks
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Memory allocation and heap management
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using fasthttprouter and fasthttp
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In order to proceed with all the recipes in this chapter, configure your environment
    according to these steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Download and install Go 1.12.6 or greater on your operating system from [https://golang.org/doc/install.](https://golang.org/doc/install)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Open a Terminal or console application and create and navigate to a project
    directory such as `~/projects/go-programming-cookbook`. All code will be run and
    modified from this directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Clone the latest code into `~/projects/go-programming-cookbook-original` and
    optionally work from that directory rather than typing the examples manually:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Optionally, install Graphviz from [http://www.graphviz.org/Home.php](http://www.graphviz.org/Home.php).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Using the pprof tool
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The `pprof` tool allows Go applications to collect and export runtime profiling
    data. It also provides webhooks to access the tool from a web interface. This
    recipe will create a basic application that verifies a `bcrypt`-hashed password
    against a plaintext one, then it will profile the application.
  prefs: []
  type: TYPE_NORMAL
- en: You might have expected the `pprof` tool to be covered in [Chapter 11](eb7b5af6-36b8-4fbb-9d06-960586569cd5.xhtml),
    *Distributed Systems*, with other metrics and monitoring recipes. It was instead
    put in this chapter because it will be used to analyze and improve a program much
    in the same way that benchmarking can be used. As a result, this recipe will largely
    focus on `pprof` for analyzing and improving the memory usage of an application.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  prefs: []
  type: TYPE_NORMAL
- en: From your Terminal or console application, create a new directory called `~/projects/go-programming-cookbook/chapter14/pprof` and
    navigate to this directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run this command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'You should see a file called `go.mod` that contains the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: Copy tests from `~/projects/go-programming-cookbook-original/chapter14/pprof`,
    or use this as an exercise to write some of your own code!
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a directory named `crypto` and navigate to it.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `handler.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Navigate up a directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a new directory named `example` and navigate to it.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a `main.go` file with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Run `go run main.go`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You may also run the following command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'You should now see the following output:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'In a separate Terminal, run the following:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: This will start a 30-second timer.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run several `curl` commands while `pprof` runs:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: Return to the `pprof` command and wait for it to complete.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run the `top10` command from the `pprof` prompt:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'If you installed Graphviz or a supported browser, run the `web` command from
    the `pprof` prompt. You should see something like this with a much longer chain
    of red boxes on the right side:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/7df536c6-2641-4619-97a3-e9ada9b6084d.png)'
  prefs: []
  type: TYPE_IMG
- en: The `go.mod` file may be updated and the `go.sum` file should now be present
    in the top-level recipe directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If you have copied or written your own tests, go up one directory and run `go
    test`. Ensure that all the tests pass.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The `pprof` tool provides a lot of runtime information about your application.
    Using the `net/pprof` package is usually the most simple to configure—all that's
    required is listening on a port and doing an import.
  prefs: []
  type: TYPE_NORMAL
- en: In our case, we wrote a handler that uses a very compute-heavy application (`bcrypt`)
    so that we can demonstrate how they pop up when profiling with `pprof`. This will
    quickly isolate chunks of code that are creating bottlenecks in your application.
  prefs: []
  type: TYPE_NORMAL
- en: We chose to collect a general profile that causes `pprof` to poll our application
    endpoint for 30 seconds. We then generated traffic against the endpoint to help
    produce results. This can be helpful when you're attempting to check a single
    handler or branch of code.
  prefs: []
  type: TYPE_NORMAL
- en: Lastly, we looked at the top 10 functions in terms of CPU utilization. It's
    also possible to look at memory/heap management with the `pprof http://localhost:8080/debug/pprof/heap`
    command. The`web` command in the `pprof` console can be used to look at a visualization
    of your CPU/memory profile and helps highlight more active code.
  prefs: []
  type: TYPE_NORMAL
- en: Benchmarking and finding bottlenecks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Another method for determining slow parts of code is to use benchmarks. Benchmarks
    can be used to test functions for average performance and can also run benchmarks
    in parallel. This can be useful when comparing functions or doing micro-optimizations
    for certain code, especially to see how a function implementation might perform
    when using it concurrently. For this recipe, we'll create two structures that
    both implement an atomic counter. The first will use the `sync` package, and the
    other will use `sync/atomic`. We'll then benchmark both the solutions.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  prefs: []
  type: TYPE_NORMAL
- en: From your Terminal or console application, create a new directory called `~/projects/go-programming-cookbook/chapter14/bench` and
    navigate to this directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run this command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'You should see a file called `go.mod` that contains the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: Copy tests from `~/projects/go-programming-cookbook-original/chapter14/bench`,
    or use this as an exercise to write some of your own code!
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note that copied tests also include benchmarks written later in this recipe.
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a file called `lock.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `atomic.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `lock_test.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `atomic_test.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'Run the `go test -bench .` command, and you will see the following output:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: If you have copied or written your own tests, go up one directory and run `go
    test`. Ensure that all the tests pass.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This recipe is an example of comparing a critical path of code. For example,
    sometimes your application must execute certain functionality often, maybe every
    call. In this case, we've written an atomic counter that can add or read values
    from multiple go routines.
  prefs: []
  type: TYPE_NORMAL
- en: The first solution uses `RWMutex` and `Lock` or `RLock` objects to write and
    read, respectively. The second uses the `atomic` package, which provides the same
    functionality out of the box. We make the signatures of our functions the same,
    so benchmarks can be reused with minor modifications and so that either can satisfy
    the same `atomic` integer interface.
  prefs: []
  type: TYPE_NORMAL
- en: Lastly, we write standard benchmarks for adding values and reading them. Then,
    we write a parallel benchmark that calls the add and read functions. The parallel
    benchmark will create lot of lock contention, so we expect a slowdown. Perhaps
    unexpectedly, the atomic package significantly outperforms `RWMutex`.
  prefs: []
  type: TYPE_NORMAL
- en: Memory allocation and heap management
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Some applications can benefit a lot from optimization. Consider routers, for
    example, which we'll look at in a later recipe. Fortunately, the tool benchmark
    suite provides flags to collect a number of memory allocations as well as memory
    allocation size. It can be helpful to tune certain critical code paths to minimize
    these two attributes.
  prefs: []
  type: TYPE_NORMAL
- en: This recipe will show two approaches to writing a function that glues together
    strings with a space, similar to `strings.Join("a", "b", "c")`. One approach will
    use concatenation, while the other will use the `strings` package. We'll then
    compare performance and memory allocations between the two.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  prefs: []
  type: TYPE_NORMAL
- en: From your Terminal or console application, create a new directory called `~/projects/go-programming-cookbook/chapter14/tuning` and
    navigate to this directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run this command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'You should see a file called `go.mod` that contains the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: Copy tests from `~/projects/go-programming-cookbook-original/chapter14/tuning`,
    or use this as an exercise to write some of your own code!
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note that copied tests also include benchmarks written later in this recipe.
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a file called `concat.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `join.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `concat_test.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `join_test.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: 'Run the `GOMAXPROCS=1 go test -bench=. -benchmem -benchtime=1s` command and
    you will see the following output:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: If you have copied or written your own tests run `go test`. Ensure that all
    the tests pass.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Benchmarking helps us tune applications and do certain micro-optimizations for
    things such as memory allocations. When benchmarking allocations for applications
    with input, it's important to try a variety of input sizes to determine whether
    it affects allocations. We wrote two functions, `concat` and `join`. Both join
    together a `variadic` string parameter with spaces, so the arguments (*a*, *b*,
    *c*) will return the string *a b c*.
  prefs: []
  type: TYPE_NORMAL
- en: The `concat` approach accomplishes this solely through string concatenation.
    We create a string and append the strings in the list and spaces in a `for` loop.
    We omit adding a space on the last loop. The `join` function uses the internal
    `Strings.Join` function to accomplish this far more efficiently in most cases.
    It can be helpful to benchmark standard library compared to your own functions
    to help better understand trade-offs in performance, simplicity, and functionality.
  prefs: []
  type: TYPE_NORMAL
- en: We used sub-benchmarks to test all of our parameters, which also work excellently
    with table-driven benchmarks. We can see how `concat` approach results in a lot
    more allocations than `join`, at least for single length inputs. A good exercise
    would be to try this with variable-length input strings as well as a number of
    arguments.
  prefs: []
  type: TYPE_NORMAL
- en: Using fasthttprouter and fasthttp
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Although the Go standard library provides everything you need to run an HTTP
    server, sometimes you need to further optimize for things such as routing and
    request time. This recipe will explore a library that speeds up request handling,
    called `fasthttp` ([https://github.com/valyala/fasthttp](https://github.com/valyala/fasthttp)),
    and a router that dramatically speeds up routing performance, called `fasthttprouter`
    ([https://github.com/buaazp/fasthttprouter](https://github.com/buaazp/fasthttprouter)).
    Although `fasthttp` is quick, it's important to note that it doesn't support HTTP/2
    ([https://github.com/valyala/fasthttp/issues/45](https://github.com/valyala/fasthttp/issues/45)).
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'These steps cover writing and running your application:'
  prefs: []
  type: TYPE_NORMAL
- en: From your Terminal or console application, create a new directory called `~/projects/go-programming-cookbook/chapter14/fastweb` and
    navigate to this directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run this command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'You should see a file called `go.mod` that contains the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: Copy tests from `~/projects/go-programming-cookbook-original/chapter14/fastweb`,
    or use this as an exercise to write some of your own code!
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a file called `items.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `handlers.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a file called `main.go` with the following content:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: Run the `go build` command.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run the `./fastweb` command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: 'From a separate Terminal, test it our with some `curl` commands:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: The `go.mod` file may be updated and the `go.sum` file should now be present
    in the top-level recipe directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If you have copied or written your own tests, run `go test`. Ensure that all
    the tests pass.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The `fasthttp` and `fasthttprouter` packages can do a lot to speed up the life
    cycle of a web request. Both packages do a lot of optimization on the hot path
    of code, but with the unfortunate caveat of rewriting your handlers to use a new
    context object rather than traditional requests and response writer.
  prefs: []
  type: TYPE_NORMAL
- en: There are a number of frameworks that have taken a similar approach to routing,
    and some have directly incorporated `fasthttp`. These projects keep up-to-date
    information in their `README` files.
  prefs: []
  type: TYPE_NORMAL
- en: Our recipe implemented a simple `list` object that we can append to with one
    endpoint and that will be returned by the other. The primary purpose of this recipe
    is to demonstrate working with parameters, setting up a router that now explicitly
    defines the supported methods instead of the generic `Handle` and `HandleFunc`,
    and to show how similar they are to standard handlers, but with many other benefits.
  prefs: []
  type: TYPE_NORMAL
