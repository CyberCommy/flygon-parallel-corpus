- en: Chapter 11. Take the Challenge — Putting It All Together
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第11章。接受挑战-把一切都放在一起
- en: Throughout the book we have discussed various techniques and methodologies that
    with practice, continual research, and diligence will allow you to perform a penetration
    test from start to finish. This chapter allows you to put some of that information
    to work and bring it into perspective.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在整本书中，我们已经讨论了各种技术和方法，通过实践、持续的研究和勤奋，可以让你从头到尾执行渗透测试。本章让你把其中一些信息付诸实践，并加以理解。
- en: 'We will discuss the following items within this chapter:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在本章讨论以下内容：
- en: Setting up the practice environment
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置实践环境
- en: Using penetration testing techniques to move from one system to the other
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用渗透测试技术从一个系统移动到另一个系统
- en: An example penetration test of a fictional company from start to finish
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个虚构公司的例子从头到尾的渗透测试
- en: The scenario
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 情景
- en: A fictional corporation named NewAlts Research Labs has decided to add a web
    presence. Due to the nature of their business model, information confidentiality
    is critical and any leakage of sensitive research data has a direct negative impact
    on their bottom line. Their administrator has set up a mock environment that is
    similar to what they would like to eventually move to production. The business
    owner has asked the administrator to hire an outside consultant to review the
    environment and inform of any vulnerabilities that may exist.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 一个名为NewAlts Research Labs的虚构公司决定增加网络存在。由于他们的商业模式的性质，信息保密至关重要，任何敏感研究数据的泄露都会直接对他们的底线产生负面影响。他们的管理员已经建立了一个模拟环境，类似于他们最终想要转移到生产环境的环境。业主已要求管理员聘请外部顾问来审查环境，并告知可能存在的任何漏洞。
- en: The administrator then contracts you to perform a penetration test on the mockup
    environment because he has ascertained that he is using security best practices
    and performed the initial vulnerability scans a few months ago and found no issues.
    He reiterates that he is using well-known products that provide great support
    and prides himself on the fact that his shop is 100 percent open source.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 然后管理员委托你对模拟环境进行渗透测试，因为他已经确定他正在使用安全最佳实践，并在几个月前执行了初始的漏洞扫描，没有发现问题。他重申他正在使用提供良好支持的知名产品，并且以他的商店100%开源为傲。
- en: When asking about the network you find that there is only one web facing server.
    This server is running the latest version of WordPress. The only other service
    mentioned is SSH which he uses to access the site in case of an emergency. When
    at the office the administrator uses a management zone to access the server directly,
    but this zone is not accessible from the Internet and is firewalled off. The IP
    address of the server is `192.168.10.25`. When asking about the environment the
    administrator lets you know that they use segmented internal networks, multiple
    firewalls, IDS, and WAF and is confident that this layered defensive approach
    is sufficient to protect the core data network where the important and confidential
    research information will eventually be stored.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 在询问网络时，你发现只有一个面向网络的服务器。这台服务器正在运行最新版本的WordPress。唯一提到的其他服务是SSH，他用它来在紧急情况下访问网站。在办公室时，管理员使用管理区域直接访问服务器，但这个区域无法从互联网访问，并且被防火墙隔离。服务器的IP地址是`192.168.10.25`。在询问环境时，管理员让你知道他们使用分段的内部网络、多个防火墙、IDS和WAF，并且确信这种分层防御方法足以保护核心数据网络，重要和机密的研究信息最终将被存储在那里。
- en: It is up to you to provide the management with the confidence that if this setup
    is to go live their data is protected. You are to emulate an attacker with no
    prior knowledge of the network and a limited timeframe to perform attacks. The
    administrator mentions that he intends to use virtual images for the servers and
    that they will be brought down and restored to the original state every evening.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要向管理层提供信心，如果这个设置要上线，他们的数据是受到保护的。你需要模拟一个没有先前网络知识和有限时间来执行攻击的攻击者。管理员提到他打算为服务器使用虚拟镜像，并且它们将在每天晚上关闭并恢复到原始状态。
- en: The setup
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 设置
- en: As usual, we will need to set up our virtual lab to emulate this environment
    as the penetration test we are performing is purely fictional. However, do not
    consider this effort in vain; many penetration testers will attempt to emulate
    the network of their client in order to ensure the exploits they intend on using
    actually work and are stable, not to mention this reduces the likelihood of diligent
    administrators and security professionals detecting your movements. Depending
    on the type of penetration test this could prove critical.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 像往常一样，我们需要设置我们的虚拟实验室来模拟这个环境，因为我们正在执行的渗透测试纯属虚构。然而，不要认为这种努力是徒劳的；许多渗透测试人员将尝试模拟他们客户的网络，以确保他们打算使用的漏洞实际上有效且稳定，更不用说这减少了勤奋的管理员和安全专业人员检测到你的行动的可能性。根据渗透测试的类型，这可能是至关重要的。
- en: NewAlts Research Labs' virtual network
  id: totrans-13
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: NewAlts Research Labs的虚拟网络
- en: 'We will set up the following environment in VirtualBox:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在VirtualBox中设置以下环境：
- en: '![NewAlts Research Labs'' virtual network](img/7744OS_11_01.jpg)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![NewAlts Research Labs的虚拟网络](img/7744OS_11_01.jpg)'
- en: 'System name: **pfsense1**'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 系统名称：**pfsense1**
- en: 'OS: pfSense 2.0 (FreeBSD)'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 操作系统：pfSense 2.0（FreeBSD）
- en: 'Virtual disk size: 1 GB'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 虚拟磁盘大小：1GB
- en: 'RAM: 128'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: RAM：128
- en: 'Three network adapters (Internal):'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 三个网络适配器（内部）：
- en: WAN = 192.168.10.1 (Int10)
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: WAN = 192.168.10.1（Int10）
- en: LAN = 192.168.20.1 (DMZ20)
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: LAN = 192.168.20.1（DMZ20）
- en: OPT1 = 192.168.30.1(DEV30)
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OPT1 = 192.168.30.1（DEV30）
- en: OPT2 = NAT (This is an optional step which allows you to easily download and
    install the necessary packages. This adapter should be disabled ASAP.)
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OPT2 = NAT（这是一个可选步骤，它允许您轻松下载和安装必要的软件包。这个适配器应尽快禁用。）
- en: 'Installed packages:'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装的软件包：
- en: Snort (Be sure to configure and update this.)
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Snort（确保配置和更新）
- en: Strikeback (Only available in the 32-bit version of pfSense.)
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Strikeback（仅在pfSense的32位版本中可用。）
- en: Set up the DHCP server for all three interfaces.
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为所有三个接口设置DHCP服务器。
- en: Allow private IPs through the WAN interface.
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许私有IP通过WAN接口。
- en: Set up rules to allow ports 22, 80, 443, and 3306 from WAN to LAN.
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置规则以允许从WAN到LAN的端口22、80、443和3306。
- en: Set up rules to allow ports 21, 22, 23, 25, 80, 443 from LAN to OPT1 and back.
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置规则以允许从LAN到OPT1和反向的端口21、22、23、25、80、443。
- en: Tip
  id: totrans-32
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: Enabling ICMP traffic while building out the lab may assist you in troubleshooting
    problems. ICMP should be blocked prior to starting the fictional penetration test.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在构建实验室时启用ICMP流量可能有助于您解决问题。在开始虚构的渗透测试之前，应阻止ICMP。
- en: 'System name: **pfsense2**'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 系统名称：**pfsense2**
- en: 'OS: pfSense 2.0 (FreeBSD)'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 操作系统：pfSense 2.0（FreeBSD）
- en: 'Virtual disk size: 1 GB'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 虚拟磁盘大小：1 GB
- en: 'RAM: 128'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: RAM：128
- en: 'Two network adapters (Internal):'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两个网络适配器（内部）：
- en: LAN= 192.168.40.2 (CORE40)
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: LAN= 192.168.40.2（CORE40）
- en: WAN = 192.168.30.2 (DEV30)
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: WAN = 192.168.30.2（DEV30）
- en: Set up DHCP for the Core (LAN) interface
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为核心（LAN）接口设置DHCP
- en: Allow private IPs through the WAN interface
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过WAN接口允许私有IP
- en: Set up rules to allow ALL from Core (WAN) to Dev (LAN) adapters
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置规则以允许从Core（WAN）到Dev（LAN）适配器的所有内容
- en: Set up rules to allow ALL from Dev (LAN) to Core (WAN)
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置规则以允许从Dev（LAN）到Core（WAN）的所有内容
- en: Tip
  id: totrans-45
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: If HDD space is at a premium, then try using pfsense1 as a linked base. This
    can be accomplished by cloning pfsense1 and choosing to link the devices. Check
    the box to reinitialize interface MAC addresses.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 如果硬盘空间有限，则尝试将pfsense1用作链接基础。这可以通过克隆pfsense1并选择链接设备来实现。选中重新初始化接口MAC地址的复选框。
- en: 'System name: **WebServer**'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 系统名称：**WebServer**
- en: 'OS: Ubuntu 10.04'
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 操作系统：Ubuntu 10.04
- en: 'Users: John Dow (jdow), Password: 039Alts2010'
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用户：John Dow（jdow），密码：039Alts2010
- en: 'Virtual disk size: 6 GB'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 虚拟磁盘大小：6 GB
- en: 'RAM: 128 MB minimum. (512 MB recommended)'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: RAM：最低128 MB（建议512 MB）
- en: 'Packages to install:'
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要安装的软件包：
- en: OpenSSH
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OpenSSH
- en: lamp-server^
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: lamp-server^
- en: WordPress (latest version)
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: WordPress（最新版本）
- en: 'Two network adapters (Internal):'
  id: totrans-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两个网络适配器（内部）：
- en: eth0 = 192.168.20.100 (DMZ20)
  id: totrans-57
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: eth0 = 192.168.20.100（DMZ20）
- en: eth1 = 192.168.30.100 (DEV30)
  id: totrans-58
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: eth1 = 192.168.30.100（DEV30）
- en: Perform all system updates prior to locking in the static IPs
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在锁定静态IP之前执行所有系统更新
- en: 'System name: **DevMachine**'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 系统名称：**DevMachine**
- en: 'OS: FreeBSD-8.2-RELEASE-i386-disc1: Located on most mirror paths as: (/pub/FreeBSD/releases/i386/ISO-IMAGES/8.2/)'
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 操作系统：FreeBSD-8.2-RELEASE-i386-disc1：大多数镜像路径上都有：（/pub/FreeBSD/releases/i386/ISO-IMAGES/8.2/）
- en: 'Users: John Doe (jdoe), Password: 1A2b3C4d!'
  id: totrans-62
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用户：John Doe（jdoe），密码：1A2b3C4d！
- en: 'Virtual disk size: 4 GB (Standard install, basic user will fit in 4 GB or less)'
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 虚拟磁盘大小：4 GB（标准安装，基本用户将适合4 GB或更少）
- en: 'RAM: 128 MB minimum (256 MB recommended)'
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: RAM：最低128 MB（建议256 MB）
- en: 'Two network adapters (Internal):'
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两个网络适配器（内部）：
- en: eth0 = 192.168.40.101 (CORE40)
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: eth0 = 192.168.40.101（CORE40）
- en: eth1 = 192.168.30.101 (DEV30)
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: eth1 = 192.168.30.101（DEV30）
- en: This system will need the default SSH and INETD (Telnet, FTP) servers installed.
    DHCP must be configured for BOTH adapters on this system or you will experience
    technical difficulties. This can be accomplished during the operating system install
    procedure. Use the user name jdoe in all instances.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 该系统将需要安装默认的SSH和INETD（Telnet，FTP）服务器。必须为此系统上的两个适配器配置DHCP，否则您将遇到技术困难。这可以在操作系统安装过程中完成。在所有情况下使用用户名jdoe。
- en: 'System name: **Kioptrix Level 1**'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 系统名称：**Kioptrix Level 1**
- en: 1 Network Adapter on CORE40 (DHCP will assign the address)
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CORE40上的1个网络适配器（DHCP将分配地址）
- en: This system will serve as a placeholder for the eventual ArchLinux database
    server that contains the company's critical infrastructure. The administrator
    claims that you should never be able to get to this zone from the `192.168.40.0/24`
    network. He is so certain of this fact that he has placed a known vulnerable system
    on the core segment to prove a point. Your goal will be to gain root on the Kioptrix
    machine from the `192.168.40.0/24` network segment.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 该系统将作为最终包含公司关键基础设施的ArchLinux数据库服务器的占位符。管理员声称您永远不应该能够从`192.168.40.0/24`网络到达此区域。他对这一事实非常确定，以至于他在核心段放置了一个已知易受攻击的系统来证明这一点。您的目标是从`192.168.40.0/24`网络段获得Kioptrix机器的root权限。
- en: Additional system modifications
  id: totrans-72
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 其他系统修改
- en: Throughout the book we have thoroughly covered the installation and configuration
    of operating systems such as pfSense and Kioptrix in a VirtualBox environment,
    thus for the sake of brevity we will focus only on those steps that make the systems
    in this exercise unique and different from the default installs. Luckily, we only
    have to worry about configuring the Ubuntu web server.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在整本书中，我们已经全面介绍了在VirtualBox环境中安装和配置操作系统（如pfSense和Kioptrix），因此为了简洁起见，我们将只关注使本练习中的系统与默认安装不同的步骤。幸运的是，我们只需要担心配置Ubuntu
    web服务器。
- en: Web server modifications
  id: totrans-74
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Web服务器修改
- en: 'The system named `Webserver` will need to have `lamp-server^` installed and
    running. As previously noted, we also need to install and configure the latest
    edition of WordPress. The WordPress team has done an excellent job at providing
    the community with step-by-step detailed installation and configuration instructions
    that can be accessed on the Internet at: [http://codex.wordpress.org/Installing_WordPress](http://codex.wordpress.org/Installing_WordPress).
    The usernames, databases, and passwords used are unimportant at this point, but
    should be easy to remember and yet strong. Remember that the administrator in
    this exercise intended on building out a secure environment. When you are testing
    this environment you will need to "forget" that you know what the passwords and
    usernames are…'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 名为`Webserver`的系统将需要安装并运行`lamp-server^`。如前所述，我们还需要安装和配置最新版本的WordPress。WordPress团队在提供社区详细的逐步安装和配置说明方面做得非常出色，可以在互联网上访问：[http://codex.wordpress.org/Installing_WordPress](http://codex.wordpress.org/Installing_WordPress)。在这一点上，使用的用户名、数据库和密码并不重要，但应该易于记住且强大。请记住，本练习中的管理员打算构建一个安全的环境。在测试此环境时，您将需要“忘记”自己知道密码和用户名是什么…
- en: In addition to fully patching and updating this system, we also need to set
    up the SSH server to accept our jdow user from a (Internet) connection which we
    emulate at 192.168.10.0/24 once WordPress, OpenSSH and and the static IPs have
    been configured.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: 'Once WordPress is up and running we need to replace the sample page with the
    following text:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'This will give us some information to work with on the site. We can move on
    to the more interesting aspects of this chapter! When browsing to our `WebServer`
    machine we should see something similar to the following screenshot:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: '![Web server modifications](img/7744OS_11_02.jpg)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
- en: The challenge
  id: totrans-81
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The lab has been set up, connections verified; it is time to put the information
    gained throughout the book to work. Challenge yourself to perform a full penetration
    test from start to finish on this environment. That includes the following items:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: Determine the scope (the administrator only allows you to have two hours on
    his VPN).
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Understand the reason why the client wants a penetration test. This is critical
    to being able to truly meet the user's needs. For some professions this is easy,
    but for penetration testers this is not always the case. Determine if your customer
    wants a penetration test or something more closely aligned with a general vulnerability
    analysis.
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Rules of engagement documentation:'
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use the provided information to create a practical rules of engagement document.
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Determine and document the scope within the ROE.
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Solidify any assumptions about the test within the ROE.
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A clearly defined goal. What do you need to do to prove success? The days of
    simply showing a screenshot with `whoami = root` is not going to be sufficient
    for most audiences.
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Decide if you will be using Dradis, Magic Tree or other data management tool
    to manage your results.
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Lay out your initial test plans. It is important to know your initial steps
    in advance of testing.
  id: totrans-91
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Perform your reconnaissance.
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Start the enumeration and decide on a plan of attack. Change your test plan
    accordingly. Depending on the scope you may be able to throw a vulnerability scan
    or an application scan against the resources. This will be loud.
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: During enumeration you should gather information about possible firewalls, IDS,
    or load balancing.
  id: totrans-94
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Execute your attack plan. Due to the nature of penetration testing this will
    vary from test to test and will sometimes even need to be changed on the fly.
    If something does not work as expected be ready with a backup plan.
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When successfully gaining access to systems perform post-exploitation and if
    required set up a pivot point to dig deeper into the network architecture.
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Achieve the goal of the penetration test.
  id: totrans-97
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Clean up.
  id: totrans-98
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Generate your reports.
  id: totrans-99
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Set up meetings to review the results with your customers.
  id: totrans-100
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Although the "exploitation" phase of penetration test is most sexy, the other
    steps are just as important to a successful penetration test. Be sure to practice
    and prepare for each step in the process. Understanding the tools and techniques
    in a penetration test is very important, but these will change constantly the
    process itself remains fairly stable and thus any effort to automate or improve
    these steps will be most beneficial in the long run.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
- en: Best of luck to you! You should be able to get all the way to root on the Kioptrix
    machine by the end of your testing. Be sure to carefully document your steps and
    any suggested changes that should be made to make the network more secure! Do
    not read ahead as it would contain spoilers that will ruin the testing for you.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
- en: The walkthrough
  id: totrans-103
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Hopefully, you have been able to complete your testing before reading this portion
    of the chapter. It will contain examples and at least one method of accomplishing
    the goal we have set which is to breach the security of the virtual NewAlts Development
    Lab running on our own network or machine. If your documentation or methodology
    to obtain the initial goal is different than that described within, it does not
    mean it is wrong, just different. With practice, penetration testers will develop
    their own methods which are tailored to their skill set and knowledgebase.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-105
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: There may be other methods to reach our goal than those described in this chapter.
    The goal of the chapter is to give an example of a penetration testing workflow
    from start to finish. If you find other methods of obtaining root on the Kioptrix
    machine in the CORE network, congratulations are due! That is what penetration
    testing is all about!
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: Defining the scope
  id: totrans-107
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The scope of this particular test can be clearly defined by reading the scenario
    objective and background information.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
- en: We have two hours to test a virtual environment that has been made to emulate
    what our client wishes to eventually use in production.
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The only user we are aware of is the administrator who has contracted us on
    behalf of the fictional NewAlts Research and Development Corporation.
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The information contained on this network is completely harmless to the corporation.
    There is not special need to keep things encrypted or to be cautious with third-party
    services.
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We are to achieve complete compromise of the Kioptrix machine that has been
    placed in the CORE 192.168.40.0/24 network segment, which is unreachable from
    the 192.168.10.0/24 segment that is emulating the Internet connection which will
    exist in the production environment.
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We may use any technique known to us including social engineering, exploitation,
    denial of service, and so on. The sky is the limit.
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: None of the data or information on these systems is in contradiction to any
    laws that we know of, state or federal. As the network is for educational purposes
    only we can do whatever we like with it.
  id: totrans-114
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: All systems on the network will be open source based.
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: With these items in mind it should become apparent that the challenge here will
    come with the limited time factor. If there are several people on our team we
    could propose that we use several testers with very specific tasks that can be
    run in parallel to make the most out of the limited two-hour testing time. (The
    admin refuses to pay for more than two hours of our standard rate which is based
    on a maximum of three testers having to join in the testing).
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: Determining the "why"
  id: totrans-117
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Although the "why" is clearly laid out for us in this instance we should not
    become complacent. It helps testers and the business alike to understand what
    the real goal of your testing is and allows you to focus on aligning your testing
    and reporting with accomplishing this goal.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: In this case, the administrator has clearly stated that vulnerability analysis
    tools have already been used against this network and he has addressed the issues
    with exception of those that the business has considered acceptable. This will
    vary from business to business, based on the risk appetite of the corporation
    or individuals you are dealing with. Understanding the risk appetite may assist
    in determining the "why" as well. Perhaps you are only testing the environment
    just to prove to the business unit that they can remain confident that it will
    take an attacker more than two hours to compromise their network, which just happens
    to be how long it takes their security teams to locate any strange activities
    occurring in their environment.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: So what is the "why" of this particular test?
  id: totrans-120
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The administrator has clearly stated that there will be a direct monetary impact
    if any of their critical data were to be collected by malicious intruders. The
    scientists who work at the corporation are not technically savvy and will be using
    rudimentary solutions to technical problems. It can be safe to say they will be
    storing unencrypted test files that are shared by multiple users on a file server
    that contain the critical data. The "why" in this case is a fear that a lot of
    money will be lost and a need for someone to assure the business that the administrator's
    suggested security configuration will be sufficient to prevent this from occurring.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: Developing the Rules of Engagement document
  id: totrans-122
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This most critical document must be clearly written, and well defined. We now
    have all of the information we need to develop the Rules of Engagement document
    and before any testing is to occur it must be presented and agreed upon.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-124
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The rules of engagement should be signed by a C-level executive who has the
    full authority to represent your client.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
- en: 'The Rules of Engagement must detail the scope, systems, network addresses,
    and what you are and are not allowed to do during testing. Regardless of the template,
    or look and feel you decide upon, the document you have created to meet the challenge
    should have at minimum the following information:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: '**The date the ROE was created:** 01/02/2020.'
  id: totrans-127
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**The names and contact information of your company and that of any testers
    that will be directly involved in testing:** Lee Allen.'
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**A summary of the request:** We are to achieve complete compromise of the
    Kioptrix machine that has been placed in the CORE network segment which is unreachable
    from the 192.168.10.0/24 segment that is emulating the Internet connection that
    will exist in the production environment.'
  id: totrans-129
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**A quick description of what a penetration test is (the following has been
    taken from** [Chapter 1](ch01.html "Chapter 1. Planning and Scoping for a Successful
    Penetration Test"), *Planning and Scoping for a Successful Penetration Test*,
    **in this book):** Penetration testing allows the business to understand if the
    mitigation strategies employed are actually working as expected; it essentially
    takes the guesswork out of the equation. The penetration tester will be expected
    to emulate the actions that an attacker would attempt and will be challenged with
    proving that they were able to compromise the critical systems targeted. This
    allows the business to understand if the security controls in place are working
    as intended and if there are any areas that need to be improved.'
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**The type of testing that will be performed:** Full compromise penetration
    test with no restrictions other than timeframe.'
  id: totrans-131
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Limitations:** 2 hour timeframe.'
  id: totrans-132
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Clearly defined goal of the penetration test:** Completely compromise the
    Kioptrix machine that resides in the CORE network segment within two hours.'
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**IP Ranges:** 192.168.10.0/24, 192.168.20.0/24, 192.168.30.0/24, 192.168.40.0/24.'
  id: totrans-134
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Data handling:** Data has been stated to be for testing only and thus not
    to be considered or treated as confidential in any manner.'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**How will any data found to be in possible violation of state or federal laws
    be handled:** Proper authorities will be notified prior to the business or its
    entities.'
  id: totrans-136
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**List of NewAlts Development contacts and their phone numbers, and so on:**
    Jon Doe.'
  id: totrans-137
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Signatures of pertinent officers of the company needed:** NewAlts Development
    CISO, CIO or other officer in charge. Unless he can prove otherwise the administrator
    does not have sufficient authority to allow you to test the assets of the NewAlts
    Development Corporation.'
  id: totrans-138
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Initial plan of attack
  id: totrans-139
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: With the ROE out of the way we can take a look at the network diagram and develop
    a plan of attack. Let's review the network layout that was provided to us by the
    administrator.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: '![Initial plan of attack](img/7744OS_11_03.jpg)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
- en: 'In this whitebox test we were provided with the network architecture to make
    up for the fact that we are testing a mock environment and are limited by a strict
    timeframe. We need to determine if the router will let us through from pfSense1
    to the WebServer and to the DevServer. It is unclear from the provided diagram
    if we can reach the Kioptrix Level 1 machine remotely or not. Our initial plan
    is as follows:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 在这次白盒测试中，我们被提供了网络架构，以弥补我们正在测试模拟环境并受到严格时间限制的事实。我们需要确定路由器是否会允许我们从pfSense1到WebServer和DevServer。从提供的图表中不清楚我们是否可以远程访问Kioptrix
    Level 1机器。我们的初始计划如下：
- en: Perform a vulnerability scan on the 192.168.10.1 firewall and gateway. We know
    about it so we may as well take advantage of it! Do the same to all systems listed
    on this diagram.
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对192.168.10.1防火墙和网关进行漏洞扫描。我们知道这一点，所以我们也可以利用它！对此图表中列出的所有系统执行相同的操作。
- en: Perform a network and vulnerability scan against 192.168.20.0/24.
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对192.168.20.0/24执行网络和漏洞扫描。
- en: If we can reach the other segments from the 192.168.10.0/24 device we will perform
    a network and vulnerability scan against those as well.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果我们可以从192.168.10.0/24设备到达其他段，我们也将对它们执行网络和漏洞扫描。
- en: If we cannot reach any of the networks we will perform a web application scan
    against the WebServer applications and see if there are any web application vulnerabilities
    we can take advantage of.
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果我们无法到达任何网络，我们将对WebServer应用程序执行Web应用程序扫描，并查看是否有任何我们可以利用的Web应用程序漏洞。
- en: This most basic of plans will suffice in getting us started. The information
    we gather from these steps should be sufficient to move us to the next steps.
    Who knows, maybe the administrator was right, and the setup is actually secure!
    (Not very likely in this case!)
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 这个最基本的计划足以让我们开始。我们从这些步骤中收集的信息应该足以让我们进入下一步。谁知道，也许管理员是对的，设置实际上是安全的！（在这种情况下不太可能！）
- en: Note
  id: totrans-148
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: With the limited scope of this test it is acceptable to use any means of documentation
    available that will allow you to provide an acceptable report to the client.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 在这次测试的有限范围内，可以使用任何可用的文档手段，以便您能够向客户提供可接受的报告。
- en: Enumeration and exploitation
  id: totrans-150
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 枚举和利用
- en: We begin by executing the first step in our action plan and scan the devices
    using the tools of our choice. In this case I decided to use MagicTree. It allows
    me to run the queries from within the app and has the ability to generate reports
    on the fly.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 我们首先执行行动计划中的第一步，并使用我们选择的工具扫描设备。在这种情况下，我决定使用MagicTree。它允许我从应用程序内运行查询，并且具有即时生成报告的能力。
- en: Load up MagicTree and create a new node as we did in [Chapter 1](ch01.html "Chapter 1. Planning
    and Scoping for a Successful Penetration Test"), *Planning and Scoping for a Successful
    Penetration Test*, of the book and run an Nmap scan against any of the networks
    that are available from the 192.168.10.0/24 subnet. If everything was configured
    properly you should only be able to see `192.168.20.1` and the `Webserver` on
    the `192.168.20.0/24` network.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 加载MagicTree并创建一个新节点，就像我们在书的[第1章](ch01.html "第1章。规划和范围确定成功的渗透测试")中所做的那样，*规划和范围确定成功的渗透测试*，并对从192.168.10.0/24子网可用的任何网络运行Nmap扫描。如果一切配置正确，您应该只能看到`192.168.20.1`和`192.168.20.0/24`网络上的`Webserver`。
- en: '![Enumeration and exploitation](img/7744OS_11_04.jpg)'
  id: totrans-153
  prefs: []
  type: TYPE_IMG
  zh: '![枚举和利用](img/7744OS_11_04.jpg)'
- en: When reviewing the data we obtain that there are some interesting services running
    on these systems that should be reviewed. Let's run a quick vulnerability scan
    against them to save time. We will use OpenVas to perform the vulnerability scan.
    OpenVas is included in BackTrack 5 R1 but must be configured properly before being
    used. Instructions on setting up OpenVas can be found on the `Backtrack-linux.org`
    site at [http://www.backtrack-linux.org/wiki/index.php?title=OpenVas&oldid=756](http://www.backtrack-linux.org/wiki/index.php?title=OpenVas&oldid=756).
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 在审查我们获得的数据时，我们发现这些系统上运行着一些有趣的服务，应该进行审查。让我们快速对它们进行漏洞扫描，以节省时间。我们将使用OpenVas执行漏洞扫描。OpenVas包含在BackTrack
    5 R1中，但必须在使用之前进行适当配置。有关设置OpenVas的说明可以在`Backtrack-linux.org`网站上找到[http://www.backtrack-linux.org/wiki/index.php?title=OpenVas&oldid=756](http://www.backtrack-linux.org/wiki/index.php?title=OpenVas&oldid=756)。
- en: Note
  id: totrans-155
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Note that OpenVas configuration will require an Internet connection.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，OpenVas配置将需要互联网连接。
- en: After realizing that the scans will take too long and would put us over the
    two-hour mark, we determine to move on to the next phase in our test plan and
    quickly determine that the installed software is reasonably updated and no well-known
    exploits are available for any of the open services. From looking at the website
    we also notice that it is a standard install of the latest version of WordPress.
    When reviewing the site closely we notice a contact e-mail address. We add this
    e-mail address to our MagicTree notes. There is a good chance the e-mail name
    **jdow** is also used as a network logon. If this is the case we have half of
    the puzzle solved. There may be a chance we can brute force Joe's SSH password.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 在意识到扫描将花费太长时间并且会使我们超过两小时的标记后，我们决定继续进行测试计划的下一阶段，并迅速确定安装的软件已经相当更新，并且没有任何已知的漏洞适用于任何开放服务。从查看网站时，我们还注意到它是最新版本的WordPress的标准安装。在仔细审查网站时，我们注意到一个联系电子邮件地址。我们将这个电子邮件地址添加到我们的MagicTree笔记中。有很大的可能性，电子邮件名称**jdow**也用作网络登录。如果是这种情况，我们已经解决了一半的难题。也许我们可以暴力破解Joe的SSH密码。
- en: At this point we decide that we will give the SSH server a try. According to
    the scope we are allowed any tool we have available which opens up brute forcing
    passwords for us. Once again, keep in mind that there is a limited timeframe for
    this test so we decide to use `cewl` to pull a password list from the website
    on 192.168.20.100.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一点上，我们决定尝试SSH服务器。根据范围，我们被允许使用任何可用的工具，这为我们打开了暴力破解密码的可能性。再次，请记住这次测试有限的时间，所以我们决定使用`cewl`从192.168.20.100的网站上拉取密码列表。
- en: '[PRE1]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This command creates a text file named `dict` in our current directory. We can
    try to run this list as is to see if these words will help us in brute forcing
    the username or password for the SSH server.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 这个命令在我们当前的目录中创建一个名为`dict`的文本文件。我们可以尝试直接运行这个列表，看看这些单词是否会帮助我们暴力破解SSH服务器的用户名或密码。
- en: We will then take that list and run it through `cupp` to add some special characters,
    concatenate words, and just generally abuse the file. After this is done we can
    save time by eliminating many of the passwords that are very unlikely to be used
    such those with only numbers such as 00000001, and so on. If the word list turns
    out too large, then remove one of the options and give it a try.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们将该列表通过`cupp`运行，以添加一些特殊字符，连接单词，并且通常滥用该文件。完成后，我们可以通过消除许多不太可能使用的密码来节省时间，例如只有数字的密码，例如00000001等。如果单词列表太大，则删除其中一个选项并尝试。
- en: '![Enumeration and exploitation](img/7744OS_11_05.jpg)'
  id: totrans-162
  prefs: []
  type: TYPE_IMG
  zh: '![枚举和利用](img/7744OS_11_05.jpg)'
- en: 'Run this list through `xhydra` using the `jdow` username and the newly generated
    password list and you will hopefully come up with the following prompt (it took
    15 minutes on the test system with the entire lab running; it may take longer
    on your system, especially since there is an entire lab using a large portion
    of your resources):'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 通过`xhydra`使用`jdow`用户名和新生成的密码列表运行此列表，您将希望出现以下提示（在测试系统上花了15分钟，整个实验室都在运行；在您的系统上可能需要更长的时间，特别是因为整个实验室使用了大部分资源）：
- en: '![Enumeration and exploitation](img/7744OS_11_06.jpg)'
  id: totrans-164
  prefs: []
  type: TYPE_IMG
  zh: '![枚举和利用](img/7744OS_11_06.jpg)'
- en: 'Now we have an SSH connection. Log into WebServer and see what the permissions
    are for the jdow account. You will realize that we do not have the ability to
    install any software. Instead we decide to use WebServer as a pivot point (SSH
    Proxy in this case) using MetaSploit. First we need to set up our SSH tunnel in
    BackTrack to the Webserver:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有了一个SSH连接。登录到WebServer，查看jdow账户的权限是什么。您会意识到我们没有安装任何软件的能力。相反，我们决定使用WebServer作为一个枢纽点（在这种情况下是SSH代理）使用MetaSploit。首先，我们需要在BackTrack中设置我们的SSH隧道到Webserver：
- en: '[PRE2]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: This creates our tunnel on port 3306 which will be used to launch our attacks.
    Here is an example of the tunnel using 443 which would add the additional benefit
    of blending in with other encrypted traffic on the network. We choose 3306 instead
    due to some stability issues with the exploit we end up using.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 这将在端口3306上创建我们的隧道，用于发动我们的攻击。这是使用443的隧道的一个示例，它将增加与网络上其他加密流量混合的额外好处。由于我们最终使用的漏洞存在一些稳定性问题，我们选择3306而不是443。
- en: '![Enumeration and exploitation](img/7744OS_11_07.jpg)'
  id: totrans-168
  prefs: []
  type: TYPE_IMG
  zh: '![枚举和利用](img/7744OS_11_07.jpg)'
- en: 'Logging into Metasploit we set up a proxy connection to allow us to use Metasploit
    through our WebServer connection. In Metasploit perform the following commands
    adapted from a mailing list response by HD Moore. The original message can be
    found at: [https://mail.metasploit.com/pipermail/framework/2010-January/005675.html](http://https://mail.metasploit.com/pipermail/framework/2010-January/005675.html).'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 登录到Metasploit，我们设置了一个代理连接，允许我们通过WebServer连接使用Metasploit。在Metasploit中执行以下命令，这些命令是根据HD
    Moore的邮件列表回复进行调整的。原始消息可以在以下网址找到：[https://mail.metasploit.com/pipermail/framework/2010-January/005675.html](http://https://mail.metasploit.com/pipermail/framework/2010-January/005675.html)。
- en: '[PRE3]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: These commands will set the global variables for your proxy and also for your
    preferred payload. We choose our default local port to be 45567.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 这些命令将设置代理和首选有效载荷的全局变量。我们选择默认的本地端口为45567。
- en: As the next step we need to confirm that there is in fact a FreeBSD machine
    available on the 192.168.30.0/24 network as we were informed by the Administrator.
    To do this we can banner grab from the Telnet server to see if there is an indication
    of which operation system is being used. This may also be a good idea to see if
    there is any information available from an NMAP scan.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 作为下一步，我们需要确认确实有一个FreeBSD机器可用于192.168.30.0/24网络，正如管理员所通知的。为了做到这一点，我们可以从Telnet服务器进行横幅抓取，看看是否有哪种操作系统正在使用的迹象。这也可能是一个好主意，看看是否有任何来自NMAP扫描的信息。
- en: With using a standard Nmap scan we notice that our traffic is being intercepted.
    We could use other methods of scanning at this point but decide to try the most
    commonly found ports manually, instead of waiting on the results of a proxied
    scan which can be slow.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 使用标准的Nmap扫描，我们注意到我们的流量被拦截。在这一点上，我们可以使用其他扫描方法，但决定手动尝试找到最常见的端口，而不是等待代理扫描的结果，这可能会很慢。
- en: Note
  id: totrans-174
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: We cannot run a standard SYN scan from this pivot. There are alternative methods
    of scanning, but that is beyond the scope of this chapter.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 我们无法从这个枢纽运行标准的SYN扫描。有替代的扫描方法，但这超出了本章的范围。
- en: '![Enumeration and exploitation](img/7744OS_11_08.jpg)'
  id: totrans-176
  prefs: []
  type: TYPE_IMG
  zh: '![枚举和利用](img/7744OS_11_08.jpg)'
- en: We happen to know that there is a known exploit for FreeBSD Telnet which the
    Administrator seems to have installed on this system (confirmed by using NetCat
    from our SSH session on the WebServer). We used `nc` to check for the most commonly
    found ports such as 80, 25, 21, and more. Before going that route we first checked
    to see if nmap or another scanner was installed.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 我们碰巧知道有一个已知的FreeBSD Telnet漏洞，管理员似乎已经安装在这个系统上（通过我们在WebServer上的SSH会话使用NetCat进行确认）。我们使用`nc`来检查最常见的端口，如80、25、21等。在采取这种方法之前，我们首先检查是否安装了nmap或其他扫描程序。
- en: '![Enumeration and exploitation](img/7744OS_11_09.jpg)'
  id: totrans-178
  prefs: []
  type: TYPE_IMG
  zh: '![枚举和利用](img/7744OS_11_09.jpg)'
- en: Let's take a shot at executing the known exploit. There is a good chance that
    the target system is vulnerable as it is a relatively new exploit.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们尝试执行已知的漏洞。目标系统很可能是脆弱的，因为这是一个相对较新的漏洞。
- en: '![Enumeration and exploitation](img/7744OS_11_10.jpg)'
  id: totrans-180
  prefs: []
  type: TYPE_IMG
  zh: '![枚举和利用](img/7744OS_11_10.jpg)'
- en: First we searched for Telnet in MSF and then we have set up everything we need
    to on `exploit/freebsd/telnet/telnet_encrypt_keyid` and are ready to attempt the
    exploit.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们在MSF中搜索Telnet，然后我们在`exploit/freebsd/telnet/telnet_encrypt_keyid`上设置了我们需要的一切，并准备尝试利用漏洞。
- en: It works and we can run a few commands to verify who we are logged in as, and
    what the system is connected to.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: '![Enumeration and exploitation](img/7744OS_11_11.jpg)'
  id: totrans-183
  prefs: []
  type: TYPE_IMG
- en: 'Notice that we can now use this system as an attack platform against 192.168.40.0/24,
    which is the CORE secure zone that the administrator mentioned. Let''s try to
    escalate privilege on the games account. We change directory to `/etc/` and run
    the following command:'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Copy the test file that is generated over the `passwd` file and we should be
    able to log in with that account now. Note: We are not able to change our password
    for the games account or any other account for that matter! The default `pam`
    security prevents us from this otherwise trivial task! This once again demonstrates
    that as a penetration tester you will have to remain diligent and never give up.
    If something does not work try again with a few changes or change the entire approach
    until you are in!'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
- en: 'Fortunately, we are on the system as root so we try `/usr/sbin/adduser` and
    set up a user named lee with the password lee. The `awk` statement is modified
    and we try again:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Now let's go over to an SSH session on the WebServer and see how our lee account
    worked out for us.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: For the next phase we must use our knowledge that the last target system is
    known to us. We already understand its vulnerabilities and have code (remember
    `10.c?)` available to us that we can compile on the 192.168.30.101 system to exploit
    the system at 192.168.40.102\. One of many methods of proceeding at this point
    include simply copying the code for `10.c` into vi and then compiling via GCC
    on the FreeBSD machine.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
- en: '![Enumeration and exploitation](img/7744OS_11_12.jpg)'
  id: totrans-191
  prefs: []
  type: TYPE_IMG
- en: Once `10.c` was compiled we were able to run it and gain root access to the
    Kioptrix level one machine. To prove that we were able to access this machine
    we decide to change the root password. This is typically not a good idea, but
    according to our rules of engagement it is fully acceptable. We change the password
    of the Kioptrix machine to `NothingIsSecure` using the `passwd` command and then
    log off and break all connections.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
- en: 'We reconnect to SSH on our WebServer machine, SSH into the DevServer:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
- en: '![Enumeration and exploitation](img/7744OS_11_13.jpg)'
  id: totrans-194
  prefs: []
  type: TYPE_IMG
- en: We follow up with a login to SSH into our Kioptrix machine using our new password
    to verify we have achieved the goal of the penetration test.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
- en: '![Enumeration and exploitation](img/7744OS_11_14.jpg)'
  id: totrans-196
  prefs: []
  type: TYPE_IMG
- en: Reporting
  id: totrans-197
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have successfully completed the penetration test and now must produce documentation.
    Your report should look professional, organized, and clearly explain the findings,
    and it should also set to non-technical language how these issues may have been
    overlooked. Focus on what allowed you to enter, but also make sure to point out
    when something worked such as the `pam` restrictions encountered when attempting
    to add a password for the standard games account (which should technically not
    exist in an environment that claims to be secure).
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s take a moment and break down the problems we encountered during this
    penetration test:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
- en: We were able to brute force a password that used upper case and lower case characters
    as well as numbers. The password was also over eight characters long which is
    fairly standard in a secured environment. At no time should a user ever use passwords
    that are based on a company name or other trivial fact. If someone has a page
    stating that they love football, then you better believe it will be in someone's
    base wordlist. The recommendation here would be to restrict the SSH connection
    to specific IPs or at minimum require certificates in addition to simple logon.
    Although this seems trivial, many corporations continue to overlook this simple
    step. Account lockouts are also a tried and true method of thwarting brute force
    password attacks.
  id: totrans-200
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We exploited a known vulnerability. Odds are that this vulnerability would have
    been patched eventually. The real problem here is that Telnet was running in the
    first place. It is a known insecure protocol that passes data in clear text. In
    this case, the business must have deemed it an acceptable risk due to the nature
    of the data being transferred. The lesson learned here should be that only critical
    services should be run at any time and that just because there is one layer of
    security does not mean that other systems can rely solely on that security mechanism.
  id: totrans-201
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Placing a known vulnerable system as the target is just asking for trouble.
    In a real world situation this will not be acceptable by any means. By using such
    a system the administrator will open up the potential for doubt in some individuals.
    They will not understand that the system represented their "hardened" server that
    will be present at launch. Explain that an attacker will have more than two hours
    to perform attacks and will install all sorts of malicious software that will
    assist in eventually cracking any hardened machine.
  id: totrans-202
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Network security devices are effective when properly monitored and controlled.
    What they are not however is a panacea. Only through defense in depth will a business
    that is on the Internet be truly secure, and even then there may be varying degrees
    of "secure" as new techniques are discovered by security researchers and malicious
    hackers alike. The thing to keep in mind is that the security researchers report
    their findings to help protect end users. When a security researcher releases
    information about a vulnerability it is important to remember that the vulnerability
    is not *new* it is newly announced. The security researcher did not create the
    vulnerability; he or she brought it to the attention of those who are responsible
    for correcting their coding errors. Malicious users may have already known about
    it and could have possibly even been using the vulnerability for years. The malicious
    attackers will keep their secrets close and maximize the profit gained from misusing
    the technology. Many businesses do not understand the distinction and it is our
    job to ensure they know who the real threat is and why security researchers perform
    the work they do.
  id: totrans-203
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If you have captured all of this and more in your mock report, congratulations!
    This challenge does not represent the most challenging environment possible, but
    was hopefully a good introduction into penetration testing of highly secured environments
    that use patched systems, firewalls, IDS's, and more to secure and protect their
    critical assets.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-205
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter we started by setting up a scenario that would allow us to emulate
    a penetration test from start to finish. We moved on to setting up the test environment
    and then delving into the stages necessary for a successful penetration test.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
- en: Once the basics were covered you were challenged to perform a test of your own
    against this environment. Hopefully, it was both challenging and exciting for
    you!
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
- en: 'We finished up the chapter by providing a walkthrough of one possible method
    of performing this penetration test. There are other ways of doing the same task,
    some better than others. The goal was to show just one of these methods. Play
    around with the lab and try additional scenarios. Use it to gain the skills you
    need or to hone the skills you have. When the time comes to do the job you will
    need all of the luck and skill you can get because if one thing is certain in
    this world: "Anything that can go wrong will go wrong" Murphy''s Law.'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
