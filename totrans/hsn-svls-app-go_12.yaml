- en: Securing Your Serverless Application
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'AWS Lambda is the ultimate pay-as-you-go cloud computing service. Customers
    just need to upload their Lambda function code to the cloud and it will be up
    and running with no underlying infrastructure to secure or patch. However, according
    to AWS''s Shared Responsibility model, you''re still responsible for securing
    your Lambda function''s code. This chapter is dedicated to the best practices
    and recommendations one can follow in AWS Lambda to make applications resilient
    and secure according to the AWS Well-Architected Framework. We will cover the
    following topics in this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: Authentication and user control access
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Encrypted environment variables
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Logging AWS Lambda API calls with CloudTrail
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Vulnerability scanning for your dependencies
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In order to follow this chapter, you can either follow the API Gateway setup
    chapter or prepare a serverless RESTful API based on Lambda and the API Gateway. The
    code bundle for this chapter is hosted on GitHub at [https://github.com/PacktPublishing/Hands-On-Serverless-Applications-with-Go](https://github.com/PacktPublishing/Hands-On-Serverless-Applications-with-Go).
  prefs: []
  type: TYPE_NORMAL
- en: Authentication and user control access
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The serverless application that we have built so far works like a charm, and
    is open to the public. Anyone can invoke Lambda functions if he/she has the API
    Gateway invocation URL. Luckily, AWS offers a managed service called Cognito.
  prefs: []
  type: TYPE_NORMAL
- en: '**Amazon Cognito** is an authentication provider and management service at
    scale that allows you to add user sign up and sign in easily to your applications.
    The users are stored in a scalable directory called the user pool. In the upcoming
    section, Amazon Cognito will be used to authenticate users before allowing them
    to request the RESTful API.'
  prefs: []
  type: TYPE_NORMAL
- en: 'To get started, create a new user pool in Amazon Cognito and give it a name:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/d64b1112-ed81-4cf4-bd8f-0395d33baa5e.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Click on the Review defaults option to create a pool with the default settings:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/9a950ec8-a55f-42ae-80fe-bb7c1341db96.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Click on Attributes from the navigation pane and tick the Allow email addresses
    option under Email address or phone number to allow users to sign in with an email
    address:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/61b2d18f-bac9-4141-93d8-4598440cedaf.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Go back to Review and click on Create pool. A success message should be displayed
    at the end of the creation process:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8d7b4995-faf5-43ad-b16b-5adad82721cf.png)'
  prefs: []
  type: TYPE_IMG
- en: 'After creating your first user pool, register your serverless API from App
    clients under General settings and select Add an app client. Give the application
    a name and uncheck the Generate client secret option as follows: the authentication
    will be done on the client side. Hence, the client secret should not be passed
    on the URL for security purposes:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/c7345bb0-aef1-47ca-b498-00796ba6a459.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Choose Create app client to register the application and copy the **App client
    id** to the clipboard:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8ae8223e-3303-4afc-abea-a50732e92be3.png)'
  prefs: []
  type: TYPE_IMG
- en: Now that the user pool has been created, we can configure the API Gateway to
    validate access tokens from a successful user pool authentication before granting
    access to Lambda functions.
  prefs: []
  type: TYPE_NORMAL
- en: Securing API access
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To begin securing API access, go to API Gateway console, choose the RESTful
    API that we built in the previous chapters, and click on Authorizers from the
    navigation bar:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/2bd40386-76ce-436d-9635-01efe30a58a9.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Click on the Create New Authorizer button and select Cognito. Then, select
    the user pool that we created earlier and set the token source field to `Authorization`.
    This defines the name of the incoming request header containing the API caller''s
    identity token for `Authorization`:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/4019bf3f-c338-4cd7-8755-673abdce6987.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Once the form has been filled in, click on Create to integrate the Cognito
    User Pool with the API Gateway:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/dcd77acd-3df6-4ac7-9fab-0ce42b730c35.png)'
  prefs: []
  type: TYPE_IMG
- en: 'You can now secure all of the endpoints, for example, in order to secure the
    endpoint responsible for listing all `movies`. Click on the corresponding `GET`
    method under the `/movies` resource:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/0e5002c8-6700-4773-9105-3e873cca9342.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Click on the Method Request box, then on Authorization, and select the user
    pool we created previously:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/76a3b295-45d7-44dd-ae21-d01da1d28f3c.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Leave the OAuth Scopes option as `None`, and repeat the preceding procedure
    for the remaining methods to secure them:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8a5148dc-b017-4b4e-b5ad-bc63e7b3672c.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Once done, redeploy the API and point your browser to the API Gateway invocation
    URL:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ec588566-1148-4fab-bd68-c938c9ed5710.png)'
  prefs: []
  type: TYPE_IMG
- en: 'This time, the endpoint is secured and requires authentication. You can confirm
    the behavior by checking the frontend we built previously. If you inspect the
    network requests, the API Gateway request should return a 401 Unauthorised error:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8dbb072f-7e1b-4e50-b8e5-877f150e006b.png)'
  prefs: []
  type: TYPE_IMG
- en: 'In order to fix this error, we will need to update the client (web application)
    to do the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Sign in to the user pool using the Cognito JavaScript SDK
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Obtain an identity token for the signed-in user from the the user pool
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Include the identity token in the `Authorization` header for the API Gateway
    requests
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The identity token returned has an expiration date of 1 hour. Once expired,
    you need to use a refresh token to refresh the session.
  prefs: []
  type: TYPE_NORMAL
- en: User management with AWS Cognito
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Before making  changes on the client side, we need to create a test user in
    Amazon Cognito. To achieve this, you can either use the AWS Management Console
    or complete this programmatically with theAWS Golang SDK.
  prefs: []
  type: TYPE_NORMAL
- en: Setting up a test user via the AWS Management Console
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Click on Users and groups and click on the Create user button:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/6166182e-436c-4ee7-a251-0701a396d16b.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Set a username and a password. If you want to receive a confirmation email,
    you can untick the Mark email as verified? box:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/d936b90b-04b4-46ab-a506-65b1bba95a25.png)'
  prefs: []
  type: TYPE_IMG
- en: Setup using Cognito Golang SDK
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Create a `main.go` file with the below content. The code uses the `SignUpRequest`
    method from the `cognitoidentityprovider` package to create a new user. As a parameter,
    it takes a struct with the client ID, username, and password:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Run the preceding command using the `go run main.go` command. You will receive
    an email with a temporary password:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/b30d2818-cda2-4dd0-8d2c-51b41b1adf88.png)'
  prefs: []
  type: TYPE_IMG
- en: 'After signing up, the user must confirm the sign up by entering a code that
    is sent via email. To confirm the sign up process, you must collect the code received
    by the user and use it as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Now that a user has been created in the Cognito User Pool, we are ready to
    update the client side. Start by creating a sign in form as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/bfb6749b-38ca-4334-84f9-4feacb9576ac.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Next, install the Cognito SDK for Javascript using the Node.js package manager.
    This package contains the Angular module and the providers you might need to interact
    with Cognito:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'Furthermore, we have to create an Angular service with an `auth` method that
    creates a `CognitoUserPool` object by providing a `UserPoolId` object and a `ClientId`, which authenticate
    a user based on the username and password given in the parameters. If the sign
    in is successful, the `onSuccess` callback is called. If the sign in fails, the `onFailure` callback
    is called:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'The `auth` method will be invoked each time the login button is clicked. If
    the user enters the right credentials, a user session will be established with
    the Amazon Cognito service, and a user identity token will be saved in the local
    storage of the browser. If the right credentials aren''t entered, an error message
    will be displayed to the user:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, the `MoviesAPI` service should be updated to include the user identity
    token (called the JWT token – [https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-with-identity-providers.html#amazon-cognito-user-pools-using-the-id-token](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-with-identity-providers.html#amazon-cognito-user-pools-using-the-id-token))
    in the `Authorization` header of each API Gateway request call, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: The preceding code samples have been tested with Angular 5\. In addition, make
    sure that you adopt the code into your own web framework accordingly.
  prefs: []
  type: TYPE_NORMAL
- en: 'To test it out, head back to the browser. The sign in form should pop up; fill
    the fields with the user credentials we created earlier. Then, click on the Login button:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/efb79861-ecf2-42da-ab30-295bd6e804b7.png)'
  prefs: []
  type: TYPE_IMG
- en: 'The user identity will be returned and the RESTful API will be called with
    the token that''s included in the request header. The API Gateway will verify
    the token and will invoke the `FindAllMovies` Lambda function, which will return
    movies from the DynamoDB table:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/4e06f787-ffe7-4840-a6ec-b98f993d2935.png)'
  prefs: []
  type: TYPE_IMG
- en: 'For web developers, Cognito''s `getSession` method can be used to retrieve
    the current user from local storage since the JavaScript SDK is configured to automatically store
    the tokens after authenticating properly, as you can see in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/fd735a23-f2b8-46d2-a44a-d643408938c3.png)'
  prefs: []
  type: TYPE_IMG
- en: 'To sum up, so far we have done the following:'
  prefs: []
  type: TYPE_NORMAL
- en: Built multiple Lambda functions to manage a store of movies
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Managed Lambda data persistency in a DynamoDB table
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Exposed those Lambda functions through the API Gateway
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Built a web client for testing the built stack in S3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Sped up web client assets with the CloudFront distribution
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Set up custom domain names in Route 53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Secured the API with AWS Cognito
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following schema illustrates the serverless architecture that we have built
    so far:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/b2e88681-4a54-4ac7-b555-14d0cfb75711.png)'
  prefs: []
  type: TYPE_IMG
- en: Amazon Cognito can be configured with multiple identity providers such as Facebook,
    Twitter, Google, or developer authenticated identities.
  prefs: []
  type: TYPE_NORMAL
- en: Encrypted environment variables
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In previous chapters, we saw how to use environment variables with AWS Lambda
    to dynamically pass data to the function code without changing any code. According
    to the **Twelve Factor App** methodology ([https://12factor.net/](https://12factor.net/))
    , you should always separate your configuration from your code to avoid checking
    sensitive credentials to a repository and to be able to define multiple releases
    of your Lambda functions (staging, production, and sandbox) with the same source
    code. Moreover, environment variables can be used to change the function behavior
    based on different settings **(A/B testing)**.
  prefs: []
  type: TYPE_NORMAL
- en: If you want to share secrets across multiple Lambda functions, you can use AWS's
    **System Manager Parameter Store**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example illustrates how environment variables can be used to
    pass MySQL credentials to the function''s code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Once the function is deployed to AWS Lambda and the environment variables are
    set, you can invoke the function. It will output a list of movies that were inserted
    into the database:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/f4cceb41-12f3-4215-bcb2-aa454bc017fa.png)'
  prefs: []
  type: TYPE_IMG
- en: So far, so good. However, the database credentials are in plain text!
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/d42646b1-597a-4f6c-8e0d-26919861d601.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Fortunately, AWS Lambda provides encryption at two levels: in transit and at
    rest, using the AWS Key Management Service.'
  prefs: []
  type: TYPE_NORMAL
- en: Data encryption at rest
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: AWS Lambda encrypts all environment variables while your function is being deployed
    and decrypts them when the function is invoked (on-the-fly).
  prefs: []
  type: TYPE_NORMAL
- en: 'If you expand the Encryption configuration section, you will notice that by
    default AWS Lambda encrypts, at rest, environment variables using a default Lambda
    service key. This key is created automatically the first time you create a Lambda
    function in a specific region:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/bc5c3a85-f548-4bfa-9d00-378a07d81c00.png)'
  prefs: []
  type: TYPE_IMG
- en: 'You can change the key and use your own by navigating to the Identity and Access
    Management Console. Then, click on Encryption keys:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/0ef2e744-13c3-4ff3-bb73-476fbb48bfdc.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Click on the Create key button to create a new customer master key:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/563e4e62-d659-444a-9648-a648d6647c4a.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Select an IAM role and account to manage the key through the **Key Management
    Service** (**KMS**) API. Then, select the IAM role you used while creating your
    Lambda function. This allows the Lambda function to use the **customer master
    key** (**CMK**) and successfully request the `encrypt` and `decrypt` methods:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/511f7fad-6191-4a7e-b796-0d12736c6f52.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Once the key is created, head back to the Lambda function configuration page
    and change the key to the one you just created:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/cd032e44-5ae4-4b8d-afc8-95a89d0c8dc6.png)'
  prefs: []
  type: TYPE_IMG
- en: Now, AWS Lambda will use your own key to encrypt environment variables at rest
    when stored in Amazon.
  prefs: []
  type: TYPE_NORMAL
- en: Data encryption in transit
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: It's recommended you encrypt environment variables (sensitive information) before
    the function is deployed. AWS Lambda provides encryption helpers on the console
    to make this process easy to follow.
  prefs: []
  type: TYPE_NORMAL
- en: 'In order to encrypt in transit (by using the KMS we used earlier), you will
    need to enable this by checking the Enable helpers for encryption in transit checkbox:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/825da2fe-8377-41e5-9e31-c90e9ca4d171.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Encrypt `MYSQL_USERNAME` and `MYSQL_PASSWORD` by clicking on the appropriate Encrypt buttons:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/92e642a0-f265-43c3-9dc1-a732bdaf46e3.png)'
  prefs: []
  type: TYPE_IMG
- en: 'The credentials will be encrypted and you''ll see them in the console as `CipherText`.
    Next, you need to update the function''s handler to decrypt environment variables
    using the KMS SDK:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: In the event you used your own KMS key, you will need to grant `kms:Decrypt`
    permissions to the execution role (IAM role) that's attached to the Lambda function.
    Also, make sure you increase the default execution timeout to allow enough time
    for the function's code to be completed.
  prefs: []
  type: TYPE_NORMAL
- en: Logging AWS Lambda API calls with CloudTrail
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Capturing all calls made by your Lambda functions is important for auditing,
    security, and compliance. It gives you a global overview of the AWS services they
    interact with. One service that leverages this feature is **CloudTrail**.
  prefs: []
  type: TYPE_NORMAL
- en: CloudTrail records API calls made by your Lambda functions. It's straightforward
    and easy to use. All you need to do is navigate to CloudTrail from the AWS Management
    Console and filter events by the event source, which should be `lambda.amazonaws.com`.
  prefs: []
  type: TYPE_NORMAL
- en: 'There, you should have all of the calls that have been made by each Lambda
    function, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/3076bb70-b308-4002-9d3e-efed9619dd94.png)'
  prefs: []
  type: TYPE_IMG
- en: 'In addition to exposing event history, you can create a trail in each AWS region
    to record your Lambda function''s events in a single S3 bucket, then implement
    a log analysis pipeline using the **ELK** (**Elasticsearch, Logstash, and Kibana**)
    stack to process your logs as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/34a908ea-63f5-4043-8909-39a441edfa46.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Finally, you can create interactive and dynamic widgets to construct a dashboard
    in kibana to view your Lambda function events:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8d853e00-8238-48c2-b162-2cb92cddfab2.png)'
  prefs: []
  type: TYPE_IMG
- en: Vulnerability scanning for your dependencies
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Since most Lambda function code contains multiple third-party Go dependencies
    (remember the `go get` commands), it''s important to carry out audits for all
    of these. Hence, vulnerability scanning your Golang dependencies should be part
    of your CI/CD. You must automate the security analysis using a third-party tool such
    as **S****nyk** ([https://snyk.io/](https://snyk.io/)) to continuously scan for
    known security vulnerabilities in dependencies.  The following  screenshot describe
    a complete end-to-end deployment process that you might choose to implement for
    your Lambda functions:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/451dcc6d-173a-4db9-b34d-e12820aee7f2.png)'
  prefs: []
  type: TYPE_IMG
- en: By making vulnerability scanning part of your workflow, you will be capable
    of finding and fixing known vulnerabilities in packages which could potentially
    cause data loss, service outages, and unauthorised access to sensitive information.
  prefs: []
  type: TYPE_NORMAL
- en: In addition, application best practices can still apply in serverless architectures,
    software engineering practices such as code review and git branches, and security
    safety checks as input validation or sanitization to avoid SQL injection.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you learned a few best practices and recommendations for building
    a secure serverless application based on Lambda functions. We covered how Amazon
    Cognito can be used as an authentication provider and how it can be integrated
    with API Gateway to secure API endpoints. Then, we looked at Lambda function code
    practices such as encrypting sensitive data using AWS KMS and input validation.
    Moreover, other practices can be useful and life saving, such as applying quotas
    and throttling to prevent a consumer from consuming all of your Lambda function
    capacity and use of one IAM role per function to leverage the principle of least
    privilege*.*
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will discuss the Lambda pricing model and how to estimate
    pricing based on the expected load.
  prefs: []
  type: TYPE_NORMAL
- en: Questions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Integrate a user in a user pool with an identity pool to allow users to log
    in with their Facebook account.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Integrate a user in a user pool with an identity pool to allow users to log
    in with their Twitter account.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Integrate a user in a user pool with an identity pool to allow users to log
    in with their Google account.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Implement a form to allow users to create an account on a web application so
    that they are able to log in.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Implement a forgotten password flow for an unauthenticated user.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
