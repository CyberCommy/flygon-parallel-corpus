- en: Chapter 4. Mail Server with Postfix
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Nowadays, many people are already using configured and reliable web-based mail
    services such as Gmail, Yahoo, and so on. Most of those people are questioning
    the need for a local e-mail server installed inside their server environment.
    Well, servers also need to send e-mails, not only humans; and it is useful for
    many other needs, especially when notifying an administrator if a server is in
    a critical state.
  prefs: []
  type: TYPE_NORMAL
- en: '**Postfix** is a high-performance open source **Mail Transfer Agent** (**MTA**)
    for Linux systems. It is fast, easy to administrate, and secure. It helps to route
    and deliver electronic mail. Postfix supports encryption and virtual domains,
    and its configuration files are clear, and easy to understand, and edit.'
  prefs: []
  type: TYPE_NORMAL
- en: The installation of Postfix will be divided into multiple sections. Since this
    chapter is all about setting up an e-mail server using Postfix and adding some
    tools to make it fully qualified and then securing it, we will do the installation
    step by step, where we are going to stretch it into the different chapter sections
    every time we add a new tool or a new tweak.
  prefs: []
  type: TYPE_NORMAL
- en: 'During this chapter, we are going to learn the following things:'
  prefs: []
  type: TYPE_NORMAL
- en: Set up and configure the Postfix e-mail server using CentOS 7 Linux
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configure it to store users and virtual domains on a MySQL database
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Set up a mail tool (Dovecot) to get e-mail
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configure the OpenLDAP active directory
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Secure both mail services using SSL/TLS
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Setting up and configuring of Postfix mail server
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As we all know, Postfix as an MTA acts, as an SMTP server. It accepts incoming
    mail and passes it to the service responsible for retrieving mails. Then it forwards
    outgoing mails to the next responsible SMTP server. For the SMTP service, we need
    to have the port 25/TCP open in the system's firewall. Postfix is very easy to
    set up and configure. We only need to make sure that some pre-installation steps
    have been done in order to have a clean setup.
  prefs: []
  type: TYPE_NORMAL
- en: 'First, we need to open the required port at the firewall for all the needed
    services for a mail server, using `Firewalld`. The ports we are going to open
    are from the following services:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Simple Mail Transfer Protocol (SMTP)**: 25 on TCP'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Secure SMTP (SMTPS)**: 465 on TCP'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Mail Submission Agent (MSA)**: 587 on TCP'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Post Office Protocol 3 (POP3)**: 110 on TCP'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Secure POP3**: 995 on TCP'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Internet Message Access Protocol (IMAP)**: 143 on TCP'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Secure IMAP (IMAP SSL)**: 993 on TCP'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'This is how to apply the change in the system local firewall using Firewalld:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'After that, we need to have an accurate time for the server, so we need to
    install an **NTP** client to synchronize the machine time with one of many worldwide
    available NTP servers. We need to install the NTP client service using the `yum`
    package manager:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Usually, an NTP client, when installed, already has some default NTP servers
    configured to synchronize its time with them. But if we have a local NTP server
    and we want to use it, we can always go to the configuration file of NTP and add
    it. As a best practice, it is advised to always have at least three NTP servers:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'We look for the lines that start with `server` and we comment the unneeded
    servers and add those that we want (shown as `LOCAL_NTP_SERVER_IP_ADDRESS` in
    the following snippet):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'We need to start the NTP service and add it to the system startup services:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'To verify whether the NTP client is synchronizing with the defined servers,
    we need to use the command `ntpq -p`. Let''s have a look at the following output:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Setting up and configuring of Postfix mail server](img/B04674_04_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'After making our server time accurate, we need to make sure that our server''s
    hostname is well configured, since a foreign mail server may not accept mail from
    our server due to its suspicious name. We can verify this using the following
    command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'If we receive a fully-qualified domain name `server.domain` we can proceed,
    where `server` is the host name of our server and `domain` is where it belongs.
    Otherwise, we need to set one by editing the hostname configuration files:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Or you can also use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: We should ensure we write a well-written domain address. Then we save the files.
  prefs: []
  type: TYPE_NORMAL
- en: 'And, finally, we need to check our DNS resolution. Our server should be using
    a fully-qualified DNS, which means that it can resolve addresses from all around
    the Web. We need to check the `/etc/resov.conf` file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'If we are not sure that the configured DNS server is well updated to handle
    all our queries, we can edit the file and add some DNS servers that we are sure
    are qualified (Google DNS: `8.8.8.8`, `8.8.4.4`). We can test our DNS server using
    the `nslookup` command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: We are now ready to install Postfix on our server. As we have mentioned before,
    the installation and the configuration will keep adding and configuring to the
    same server for each section.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this section, we will start by installing and configuring our Postfix as
    an SMTP server. First, we need to install the `postfix` package using `yum`. We
    need to plan for the coming sections. Since the default version of Postfix in
    the `yum` package manager doesn''t support **MariaDB** (the drop-in replacement
    for MySQL), we need to install Postfix from the **CentOSPlus repository**. Just
    before starting the installation, we need to add an exclusion to some repositories
    to prevent overwriting the Postfix packages update:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we need to make sure to add the line `exclude=postfix` to the end of the
    `[base]` and the `[updates]` repository source to look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'After saving the file, we can start the package installation. We will do the
    installation of the essential packages to have a fully-functioning mail server:
    Postfix as an MTA mail server for the SMTP, Dovecot serves for IMAP, and POP daemons
    and some supporting packages for the authentication service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: Here, we will merge the installation of the tools but the configuration will
    be separated into each section of this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: 'After having the Postfix mail server installed, we can start with the configuration.
    Postfix has almost all of its options as either commented or not fully applicable.
    So to have Postfix fully configured we need to go to its main configuration file
    and make some changes. First, we open the file using any text editor:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: Then we start changing uncommented lines and adding information about the desired
    mail server. Since we are going to make many separate changes in a big file, we
    should not add any unnecessary lines because we will be pointing to which line
    we should change at a time. At any point if we are using **nano** as a text editor
    we can always use the search option to look up the desired line using the combination
    of *Ctrl* + *W* and typing in the first part of the line.
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we need to define our mail server hostname. We go to the line of the
    option `myhostname` and we uncomment the line and change it with the desired information,
    such as in the following example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, we need to set up the domain name at the line of the option `mydomain`,
    as shown in the following example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'This is followed by the origin, which has the same value as the domain, at
    the line of the option `myorigin`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we define which network interfaces our server will be providing its services
    (listening) to. In our case we will just use all of them. To set up that, we either
    comment line `116` and uncomment line `113`, or just change line `116` to the
    following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we move to the line of the option `mydestination` to add the domain address
    to the end of the destination domain''s line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we make a big jump to the line of the option `mynetworks` to uncomment
    it and add the other networks that we will be using for the network related to
    the server:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we jump to the line of the option `home_mailbox` to uncomment the mailbox
    folder location option and change it to whatever suits our needs:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'We end the line counting by going to the line of the option `smtpd_banner`
    and uncomment it and changing it to look like the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we go to the end of the file and add the following lines and limit the
    e-mail size for the server to handle (10 mega bytes= 10485760):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: 'Also, we need to limit the mailbox folder size (1 giga bytes= 1073741824):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: 'And, finally, we set up the SMTP server authentication configuration option
    lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'This configuration is considered as the initial one. After having it set, we
    can always use the command `postconf -e` to change an option or set a new one.
    If we ever needed to change the server hostname, we need to write it as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: 'After making sure that all configurations are well set, we can start our Postfix
    service and add it to the system startup services:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 'Just to verify that everything is ok, we need to do a small test to the Postfix
    services. There are many ways to do this test. We will go with the traditional
    way of sending a mail using the command `mail` and then verifying the mail log
    file located at `/var/log/maillog`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we should see the following message in the mail log file, which tells
    us the following message to know that the mail has been sent ok and the Postfix
    services are working fine:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: 'With this step, we can say that we have successfully configured Postfix as
    an MTA. But this may not be a well set up mail server. We need to add and configure
    a few tools to help make it well qualified and secure. We will start adding and
    configuring the necessary tools during the next sections. This is how our mail
    server will look like after having all it components installed and running:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Setting up and configuring of Postfix mail server](img/B04674_04_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Setting up MariaDB for virtual domains and users
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Since we have already installed **MariaDB** (the drop-in replacement for MySQL)
    during the postfix installation, we can proceed to the configuration. But if we
    ever needed to reinstall the package again, we can always use `yum`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: 'The first thing to do to start the MariaDB configuration is to start the service.
    Also, we need to add it to the system startup services:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we start the configuration by setting up the secure installation mode
    where we can set up or change the MariaDB root password, remove anonymous user
    accounts, disable root logins outside of the local host, and so on:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: We should make sure to answer yes at the end to finish the configuration.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now we have the MariaDB service well configured and ready to be used. We will
    start setting up the new database to use it with Postfix. To add the new database,
    we need to open the MariaDB shell:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we create a new database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: 'Next, we switch to that database to start making changes in it:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we create a database user to be the mail administrator by granting them
    permissions on the mail database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: The administrator password `mail_admin_password` should be a very strong password
    to better secure the mail server database.
  prefs: []
  type: TYPE_NORMAL
- en: 'Then we submit the change:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we start creating the necessary tables inside our database. First, we create
    the virtual domains table:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we create the table that handles mail forwarding:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: 'Next, we create the table in which we are going to store the mail server users:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, we create the transports table:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: 'We have set up our mail server database table''s initial configuration successfully.
    We can now leave the MariaDB shell:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: 'To enable Postfix to communicate with the MariaDB server, we need to set up
    MariaDB to listen to the localhost at IP address `127.0.0.1`. To set this configuration,
    we need to edit `/etc/my.cnf` and add the following section `[mysql]`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we restart the MariaDB service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: We are not yet finished with our mail server database configuration. Now we
    go back to the Postfix configuration to set up communication with the database
    earlier created code within MariaDB. So we need tell Postfix which table of which
    database it should use to store specific information (users, virtual domains,
    and so on).
  prefs: []
  type: TYPE_NORMAL
- en: 'We start by creating configuration files for each table. For the virtual domains
    configuration, we are creating a file called `/etc/postfix/mysql-virtual_domains.cf`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we put the following code inside it and save it:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  prefs: []
  type: TYPE_PRE
- en: Again, the `mail_admin_password` should be replaced with the strong one that
    we created earlier. This goes for all of the following files that we are going
    to create.
  prefs: []
  type: TYPE_NORMAL
- en: 'Then we create the configuration file for the virtual forwarding at `/etc/postfix/mysql-virtual_forwardings.cf`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  prefs: []
  type: TYPE_PRE
- en: 'We add the following code inside it:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  prefs: []
  type: TYPE_PRE
- en: 'We create another configuration file for the virtual mailbox called `/etc/postfix/mysql-virtual_mailboxes.cf`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  prefs: []
  type: TYPE_PRE
- en: 'And we insert the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  prefs: []
  type: TYPE_PRE
- en: 'And, finally, we do the same for the virtual e-mail mapping by creating the
    file `/etc/postfix/mysql-virtual_email2email.cf`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  prefs: []
  type: TYPE_PRE
- en: 'Then add the following code inside it and save it:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we set the files'' permissions and ownership to make Postfix able to handle
    the new configuration files:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we create a user and group for mail handling. The virtual mailboxes will
    be all stored under this user home directory. We are choosing the group 5000 to
    keep our distance from the ones created by the system for the regular users:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: To complete the configuration, we need to make some minor changes to the Postfix
    configuration. We will not open the configuration file and edit it, we will only
    add them using the command `postconf -e`.
  prefs: []
  type: TYPE_NORMAL
- en: 'We start by locating the new configuration file created to address the database
    tables:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we set the location where the mailbox folder will be created:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, we see the user UID who will take control of the configuration files
    and add the mailbox folder:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: 'To finish the mail server database configuration, we need to restart the Postfix
    service to submit the change:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE57]'
  prefs: []
  type: TYPE_PRE
- en: 'We can say that we have finished our mail server database service. Still, if
    we need to configure Postfix with the virtual domain to use them to send e-mail
    with a domain name different from the system''s default domain name, we need to
    make some minor modifications to the Postfix main configuration file. Also, we
    can always use the command `postconf -e` to make quick changes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE58]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we add the following code at the end of the file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we need to add the new domain to the virtual domain file, `/etc/postfix/virtual`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE60]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we add the following snippet anywhere:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we apply the change by refreshing the Postfix map and restarting the service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]'
  prefs: []
  type: TYPE_PRE
- en: Setting up a mail tool (Dovecot) to retrieve mails
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'As we have said earlier, **Dovecot** is an open source **IMAP** and **POP3**
    server. It is fast, easy to set up and configure, and it uses very little RAM
    memory. For this section, we are going to install it to work with Postfix as **MDA**
    (POP/IMAP service) and sieve for sorting mail at the mail server POP/IMAP service.
    As this image shows, Dovocot is positioned between the user mailbox and Postfix:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Setting up a mail tool (Dovecot) to retrieve mails](img/B04674_04_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Since we have already installed Dovecot, we now only need to configure it to
    work alongside Postfix. If we ever miss the installation, we can always use the
    `yum` package manager to reinstall it:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, we need to add Dovecot support to the Postfix configuration file. Again,
    we will not go and edit the file; we will only use the command `postconf -e`.
    First, we need to enable Dovecot to use the SMTP and enable the service authentication:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE64]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we enable Postfix to create and extend the mail directory if needed:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE65]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, we set the mail transport parameters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE66]'
  prefs: []
  type: TYPE_PRE
- en: 'For this section, we will use the default security option provided by Dovecot
    so we need to tell Postfix to use the SSL certificate and key provided by Dovecot:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE67]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we move to the service configuration file of Postfix, `/etc/postfix/master.cf`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  prefs: []
  type: TYPE_PRE
- en: 'Add the Dovecot service to the bottom of the file, then save it and exit:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we move to the Dovecot service configuration. Before we start the configuration,
    we need to have a copy of the initial configuration file backed up:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE70]'
  prefs: []
  type: TYPE_PRE
- en: 'For this example, we are going to create our own new configuration file where
    we will specify every single parameter one by one. We will create a new file with
    the same name as the original configuration file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we add the following code without the description:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE72]'
  prefs: []
  type: TYPE_PRE
- en: 'We save the file to have the configuration stored. Then we need to create the
    database files already assigned to the Dovecot configuration file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we add the following code, changing the mail administrator password `mail_admin_password`
    for the one already set in an earlier section where we have setup the MariaDB
    database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we arrange the files permission and ownership to restrict access to the
    files:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE75]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we move to configure the Dovecot authentication parameters located in
    its configuration folder, `/etc/dovecot/conf.d/`. We start with the authentication
    process configuration file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE76]'
  prefs: []
  type: TYPE_PRE
- en: 'We need to locate the following lines and change them:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE77]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we move to the mailbox configuration file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE78]'
  prefs: []
  type: TYPE_PRE
- en: 'Then uncomment the following line and change its end to match with the following
    code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE79]'
  prefs: []
  type: TYPE_PRE
- en: 'Similarly, we need to edit the master configuration file to define the Postfix
    user who will use the SMTP authentication:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE80]'
  prefs: []
  type: TYPE_PRE
- en: 'Then uncomment the `unix_listener /var/spool/postfix/private/auth` section,
    and add it to the user and group lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE81]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, we configure the SSL authentication configuration file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE82]'
  prefs: []
  type: TYPE_PRE
- en: 'And we change the SSL option from `no` to `yes`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE83]'
  prefs: []
  type: TYPE_PRE
- en: 'Before starting the test, we need to make sure that we have defined two variables
    in our `/etc/aliases` configuration file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE84]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we check the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE85]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we update the aliases list:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE86]'
  prefs: []
  type: TYPE_PRE
- en: 'And to finish the Dovecot configuration, we need to restart both the Postfix
    and Dovecot services. Also, we need to add Dovecot to the system startup services:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE87]'
  prefs: []
  type: TYPE_PRE
- en: 'To verify that the services are running well and there is no problem with the
    configuration files we need to check the mail log file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE88]'
  prefs: []
  type: TYPE_PRE
- en: 'We should see something like the following code to know that Dovecot is running
    well:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE89]'
  prefs: []
  type: TYPE_PRE
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Sometimes, SELinux prevents Dovecot from using the system resource so we need
    to grant Dovecot access to the system resource, or if we have an alternative way
    to secure the server we can either disable SELinux or set it as permissive.
  prefs: []
  type: TYPE_NORMAL
- en: At this point, our mail server is fully qualified to work as a sender and receiver
    with a well-organized database and a medium security level. We can start testing
    our mail server.
  prefs: []
  type: TYPE_NORMAL
- en: 'First, we will use the **Telnet** service to check that **Postfix SMTP-AUTH**
    and **TLS** are working fine. We need to install Telnet and if it doesn''t exist
    on the system, run the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE90]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we run the test:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE91]'
  prefs: []
  type: TYPE_PRE
- en: 'Telnet will connect and we will see the Telnet shell, inside which we type
    inside the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE92]'
  prefs: []
  type: TYPE_PRE
- en: 'To know that our test is positive, we need to see the following message:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE93]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we exit the Telnet shell:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE94]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we will test the mail service. To do that, we need to first populate our
    database with a test domain and user. First, we enter the MariaDB database shell:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE95]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we switch to our mail database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE96]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we create a new domain at the domains table:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE97]'
  prefs: []
  type: TYPE_PRE
- en: 'We add a new user to that domain. We need to enter a good password for the
    real users later:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE98]'
  prefs: []
  type: TYPE_PRE
- en: Then we exit the MariaDB shell.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now we need to send a test mail to our newly created user. We need to use **Mailx**,
    so if we don''t have it installed we need to do so before the test:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE99]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we send our test mail:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE100]'
  prefs: []
  type: TYPE_PRE
- en: We need to put the `Subject` and then press *Enter*. If we ever need to insert
    a copied address, we need to write `Cc:` then add the copied address. Then we
    type in the message and press *Enter*, then to send it we need to put `.` at the
    end and press *Enter*.
  prefs: []
  type: TYPE_NORMAL
- en: To check whether the mail has been sent, we go to the mail log file;
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE101]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we should see something like the following code to know that it is ok:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE102]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we check the Dovecot delivery by visualizing the Dovecot delivery log:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE103]'
  prefs: []
  type: TYPE_PRE
- en: 'And we should see something like the following line to make sure that it is
    working:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE104]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we can test our mailbox via the mail client. For this example, we are going
    to use **Mutt**, which is a simple mail client. But before using it, we need to
    install it first:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE105]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we need to go to the location where the new user mailbox is stored and
    run Mutt:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE106]'
  prefs: []
  type: TYPE_PRE
- en: 'And now we run Mutt:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE107]'
  prefs: []
  type: TYPE_PRE
- en: The message showing that we need to create a root mailbox is not required, so
    we can skip it. And to exit Mutt type `q`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Then we will have a pretty clear interface where we can navigate using keyboard
    direction and press *Enter* to see what is inside the mail. To confirm that our
    mail server is well configured and running, we should see the test mail that we
    have sent using Mailx:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Setting up a mail tool (Dovecot) to retrieve mails](img/B04674_04_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Configuring the OpenLDAP Active Directory with Postfix
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: For this section, we are going to use OpenLDAP as a backend to both our Postfix
    (as an MTA) and Dovecot (as an POP3/IMAP server) users, in order for them to be
    connected to each other, and help with address lookup and aliases.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: OpenLDAP is an open source implementation of the **Lightweight Directory Access
    Protocol** (**LDAP**). This section doesn't cover how to install an OpenLDAP server.
    We will assume that we have one already configured inside our network.
  prefs: []
  type: TYPE_NORMAL
- en: 'Our OpenLDAP server has the following information as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE108]'
  prefs: []
  type: TYPE_PRE
- en: 'For the configuration of the LDAP settings for both of our services, we need
    to edit and add some options to their configuration files. We will start with
    Dovecot. We will first open the Dovecot main configuration file with a text editor,
    then make the necessary changes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE109]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we check the following options if any change is needed or, if they don''t
    exist, we need to add them:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE110]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we need to create the LDAP database files and populate them:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE111]'
  prefs: []
  type: TYPE_PRE
- en: 'Next, we add the following code with the necessary change, then we save:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE112]'
  prefs: []
  type: TYPE_PRE
- en: 'The following image shows, OpenLDAP serves both inbox and outbox mail services:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Configuring the OpenLDAP Active Directory with Postfix](img/B04674_04_04.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'We do the same thing for the second LDAP database file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE113]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we add the following code with the necessary change, save the file, and
    exit:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE114]'
  prefs: []
  type: TYPE_PRE
- en: 'With this step, we can say that Dovecote is successfully configured to use
    our LDAP server. We proceed to the Postfix configuration. As usual we can edit
    the main configuration file, `/etc/postfix/main.cf` using a text editor or we
    can just use the fast configuration setup command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE115]'
  prefs: []
  type: TYPE_PRE
- en: 'Then to submit the change, we need to restart both services:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE116]'
  prefs: []
  type: TYPE_PRE
- en: Securing the mail server using SSL/TLS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: SSL/TLS encryption for Postfix gives our mail server the capacity to not only
    authenticate remote SMTP servers but also to encrypt the e-mails that we send
    between our server and the receiver's server.
  prefs: []
  type: TYPE_NORMAL
- en: To configure SSL to encrypt connections, we first need to create our own personalized
    and specific SSL certificates.
  prefs: []
  type: TYPE_NORMAL
- en: 'We need to go the TLS certificates directory to create our new certificate
    there:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE117]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we create our first key file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE118]'
  prefs: []
  type: TYPE_PRE
- en: Then the tool will ask for a passphrase. We should give something strong and
    retype it when the tool asks us to do so.
  prefs: []
  type: TYPE_NORMAL
- en: 'After that we need to start using the OpenSSL tool; so if it is not installed
    we need to install it first:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE119]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we use OpenSSL to write the RSA key:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE120]'
  prefs: []
  type: TYPE_PRE
- en: Then write in the passphrase that has already defined and carry on to have the
    key generated.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now we move on to certificate creation. In the same folder, we run the following
    command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE121]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we fill in the information as each filed asked: **Country Name**, **State
    or Province Name**, **Locality Name**, **Organization Name**, **Organizational
    Unit Name**, **Common Name**, and **Email Address** and for the final two entries
    (A challenge password, and an optional company name) we can skip them.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Then we create a private key using OpenSSL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE122]'
  prefs: []
  type: TYPE_PRE
- en: Then we move to the configuring Postfix and Dovecot to use the SSL/TLS encryption.
  prefs: []
  type: TYPE_NORMAL
- en: First, we are going to start by setting up Postfix to use SSL/TLS by making
    some modifications at its main configuration file, `/etc/postfix/main.cf`. We
    can always use a text editor to edit the file and change the parameters, or we
    can just use the command `postconf -e` to set them up in a faster way.
  prefs: []
  type: TYPE_NORMAL
- en: 'We will add some lines to the Postfix configuration file to protect it from
    some recent attacks against OpenSSL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE123]'
  prefs: []
  type: TYPE_PRE
- en: 'We create the cert file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE124]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we need to make sure that the TLS is enabled to be used with SMTP:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE125]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we need to redefine the certificate and key files position:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE126]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we set the location of the TLS session database cache:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE127]'
  prefs: []
  type: TYPE_PRE
- en: 'That is all for the main configuration file. We will now configure `/etc/postfix/master.cf`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE128]'
  prefs: []
  type: TYPE_PRE
- en: 'We need to uncomment some options of `Submission` and `SMTPS` between lines
    `16` to `35` of the original file, to look like the following uncommented:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE129]'
  prefs: []
  type: TYPE_PRE
- en: 'We have finished with the Postfix configuration to use SSL. We can now configure
    SSL for Dovecot. We only need to make a few changes at the `/etc/dovecot/conf.d/10-ssl.conf`
    file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE130]'
  prefs: []
  type: TYPE_PRE
- en: 'First, we need to make sure that the SSL option is activated:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE131]'
  prefs: []
  type: TYPE_PRE
- en: 'Then we change the SSL certificate and key location:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE132]'
  prefs: []
  type: TYPE_PRE
- en: 'And, finally, we need to restart the services to submit the change:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE133]'
  prefs: []
  type: TYPE_PRE
- en: References
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now that we have gone through the chapter, let''s take a look at the references
    used:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Postfix home page: [www.postfix.org](http://www.postfix.org)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Postfix MySQL support: [http://www.postfix.org/MYSQL_README.html](http://www.postfix.org/MYSQL_README.html)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Dovecot home page overview: [http://www.dovecot.org](http://www.dovecot.org)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Postfix virtual hosts overview: [http://www.akadia.com/services/postfix_separate_mailboxes.html](http://www.akadia.com/services/postfix_separate_mailboxes.html)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Dovecot configuration file: [http://wiki.dovecot.org/MainConfig](http://wiki.dovecot.org/MainConfig)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'LDAP support in Postfix: [http://www.postfix.org/LDAP_README.html](http://www.postfix.org/LDAP_README.html)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Postfix TLS support: [http://www.postfix.org/TLS_README.html](http://www.postfix.org/TLS_README.html)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This chapter describes in a step-by-step tutorial how to set up a fully-qualified
    mail server starting from sending a service SMTP using Postfix. We then started
    organizing the mail server, focusing on sending/receiving mail and virtual domains
    management via a secure database service MariaDB. Next, we learned about the mail
    reception service using POP3/IMAP using the MDA Dovecot with a medium level of
    security provided by the service itself. Then to start the extension part, which
    shows when the server can connect to an LDAP server and can gather useful information
    about the users and use them to send and receive mail. Finally, we finished off
    with a customized security level using OpenSSL to generate new certificate and
    keys to secure the service's authentication and encryption of the e-mails to be
    sent.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will learn how to set up and configure tools such as
    Nagios and syslog-ng on CentOS to monitor different services, and collect and
    process logs.
  prefs: []
  type: TYPE_NORMAL
