- en: Chapter 8. Accessing Databases
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Setting up SQL Driver for Qt
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Connecting to a database
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Writing basic SQL queries
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating a login screen with Qt
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Displaying information from a database on a model view
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Advanced SQL queries
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '**SQL** stands for **Structured Query Language**, a special programming language
    used to manage data held in a relational database management system. A SQL server
    is a database system designed to use one of the many types of SQL programming
    language to manage its data.'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-10
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If you want to learn more about SQL, visit this link: [http://www.w3schools.com/sql/sql_intro.asp](http://www.w3schools.com/sql/sql_intro.asp).'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: Qt supports several different types of SQL driver in the form of plugins/add-ons.
    However, it's very easy to integrate these drivers to your Qt project. We will
    learn how to do it in the following example.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: How to do it…
  id: totrans-13
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let''s set up our SQL server before we dive into Qt:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: Before setting up Qt for SQL, we need to install and set up a MySQL server.
    There are many ways you can install it. The first method is to download MySQL
    from the official website at [http://dev.mysql.com/downloads/mysql/](http://dev.mysql.com/downloads/mysql/)
    and install it. After that, you also need to install the MySQL Workbench from
    [http://dev.mysql.com/downloads/workbench/](http://dev.mysql.com/downloads/workbench/)
    to administrate your databases.
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: An alternative method is to install a third-party package that comes with MySQL
    and other useful applications, such as Apache web server, phpMyAdmin, and so on,
    all in a unified installer. Examples of such packages are XAMPP, [https://sourceforge.net/projects/xampp/](https://sourceforge.net/projects/xampp/),
    and AppServ, [https://www.appservnetwork.com/en/download/](https://www.appservnetwork.com/en/download/).
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In this example, we will install XAMPP. Open up your web browser, download the
    XAMPP installer from [https://sourceforge.net/projects/xampp/](https://sourceforge.net/projects/xampp/),
    and proceed to install it on your computer.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once you have installed XAMPP, open up XAMPP Control Panel and you should see
    something like this:![How to do it…](img/B02820_08_01.jpg)
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What we need is the Apache web server and the MySQL database server. Click the
    **Start** buttons next to the **Apache** and **MySQL** options on the control
    panel.
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the servers have been started, open up your web browser and visit [http://localhost/phpmyadmin/](http://localhost/phpmyadmin/).
    You will see a web interface by the name of **PhpMyAdmin** that looks like this:![How
    to do it…](img/B02820_08_02.jpg)
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: phpMyAdmin is a web-based utility that help you manage your MySQL databases,
    much like the official MySQL Workbench. In my opinion, phpMyAdmin is a lot simpler
    and better suited for beginners, which is why I recommend using it instead of
    MySQL Workbench.
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: By default, phpMyAdmin automatically logs in to MySQL using the default user
    account `root`, which is saved in its configuration file. We don't want to use
    that for security reasons. So the next thing we need to do is to create an account
    for ourselves. Go to the **Users** tab located at the top and once you're on that
    page, click **Add user** located at the bottom. Key in your desired username and
    password in the fields in the login information pane. Choose **Local** for the
    **Host** option for now. At the bottom, you will see options related to **Global
    privileges**; check the **Check All** option and click **Go**:![How to do it…](img/B02820_08_03.jpg)
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Now that you have created your user account, go to XAMPP Control Panel and click
    **Stop** for both Apache and MySQL. Then, click the **Config** button on the **Apache**
    column and select the **phpMyAdmin (config.inc.php)** option. After that, the
    `config.inc.php` file will be opened with your choice of text editor.
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Search for the following line in `config.inc.php` and change the word `config`
    to `cookie`:'
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: After that, start Apache and MySQL again by clicking the **Start** buttons.
    This way, we force phpMyAdmin to reload its configurations and apply the changes.
    Go to phpmyAdmin again from your web browser, and this time around, a login screen
    should appear on the screen:![How to do it…](img/B02820_08_04.jpg)
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Log in to phpMyAdmin, then click on the **New** link located on the side bar:![How
    to do it…](img/B02820_08_05.jpg)
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Key in your desired database name and press the **Create** button. Once it's
    been created, the database name will appear on the side bar. Click on the database
    name and it will bring you to another page, which displays a message, **No tables
    found in database**. Under the message, you can create your first data table by
    filling in your desired table name and the number of columns for the table:![How
    to do it…](img/B02820_08_06.jpg)
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'After you click the **Go** button, you will be brought to another page where
    you will set up the new table you''re going to create. In this example, we created
    an `employee` table that consists of five columns of data: `id`, `name`, `age`,
    `gender`, and `married`:![How to do it…](img/B02820_08_07.jpg)'
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once you are done with that, click **Save** and now you will be able to see
    the `employee` table name appear on the side bar. We have successfully installed
    MySQL and set up our first database and data table.
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After that, we need to insert data into the database from phpMyAdmin so that
    we will be able to retrieve it in the next example. Click on the **Insert** tab
    while you're still in the `employee` table; you will then be brought to another
    page for inserting new data into the `employee` table:![How to do it…](img/B02820_08_08.jpg)
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Next, we will proceed to set up the SQL driver for our Qt project. Basically,
    all you need to do is to go to your Qt installation folder and look for the `sqldrivers`
    folder. For example, mine is located at `C:\Qt\5.5\mingw492_32\plugins\sqldrivers`.
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy the entire `sqldrivers` folder to your project's build directory. You can
    remove the DLL files that are not relevant to the SQL server you're running. In
    our case, since we're using a MySQL server, we can delete everything except `qsqlmysql.dll`
    and `qsqlmysqld.dll`. The DLL file with the letter `d` at the back is for debug
    builds only, while the other one is for release builds. Put those DLL files in
    their respective build directories, for example, `builds/debug/sqldrivers/qsqlmysqld.dll`
    for debug builds and `builds/release/sqldrivers/qsqlmysql.dll` for release builds.
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The DLL files mentioned in the previous step are the drivers that enable Qt
    to communicate with different types of SQL architecture. You may also need the
    DLL file of the SQL client library in order for the driver to work. In our case,
    we need `libmysql.dll` to be located in the same directory as our program's executable.
    You can either get it from the installation directory of MySQL or download the
    Connector/C++ package from the official website, [https://dev.mysql.com/downloads/connector/cpp/](https://dev.mysql.com/downloads/connector/cpp/).
  id: totrans-34
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works…
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Qt provides us with SQL drivers so that we can easily connect to different types
    of SQL servers without implementing them ourselves.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: Currently, Qt officially supports SQLite, MySQL, ODBC, and PostgreSQL. SQL architectures
    that are forks from one of the supported architectures, such as MariaDB (a fork
    of MySQL), may still compatible with Qt without much problem.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: If you are using an architecture that isn't supported by Qt, you can still interact
    with your SQL database indirectly by sending an HTTP request using QNetworkAccessManager
    to your backend script (such as PHP, ASP, JSP, and so on), which can then communicate
    with the database.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: If you only need a simple file-based database and don't plan to use a server-based
    database, SQLite is a good choice for you.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: Connecting to a database
  id: totrans-40
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will learn how to connect to our SQL database using Qt's
    SQL module.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: How to do it…
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Connecting to SQL server in Qt is really simple:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: First of all, open up Qt Creator and create a new **Qt Widgets Application**
    project.
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Open up your project file (`.pro`) and add the SQL module to your project,
    like so:'
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Next, open up `mainwindow.ui` and drag seven label widgets, a combo box, and
    a checkbox to the canvas. Set the text properties of four of the labels to `Name:`,
    `Age:`, `Gender:`, and `Married:`. Then, set the `objectName` properties of the
    rest to `name`, `age`, `gender`, and `married`. There is no need to set the object
    name for the previous four labels because they're for display purposes only:![How
    to do it…](img/B02820_08_09.jpg)
  id: totrans-47
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'After that, open up `mainwindow.h` and add the following headers below the
    `QMainWindow` header:'
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Then, open up `mainwindow.cpp` and insert the following code to the class constructor:'
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Compile and run your project now and you should get something like the following:![How
    to do it…](img/B02820_08_10.jpg)
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works…
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The previous example shows you how to connect to your SQL database using the
    `QSqlDatabase` class derived from the SQL module. You won't be able to access
    any of the classes related to SQL without adding the module to your Qt project.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: We must tell Qt which SQL architecture we are running by mentioning it when
    calling the `addDatabase()` function. Options supported by Qt are QSQLITE, QMYSQL,
    QMYSQL3, QODBC, QODBC3, QPSQL, and QPSQL7
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: 'If you encounter an error message that says, **QSqlDatabase: QMYSQL driver
    not loaded**, then you should again check whether the DLL files are placed in
    the correct directory.'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
- en: We can send our SQL statements to the database through the `QSqlQuery` class,
    and wait for it to return the results, which usually are either the data you requested
    or error messages due to invalid statements.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: If there is any data coming from the database server, it will all be stored
    in the `QSqlQuery` class. All you need to do to retrieve this data is to do a
    `while` loop on the `QSqlQuery` class to check for all existing records, and retrieve
    them by calling the `value()` function.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: Writing basic SQL queries
  id: totrans-59
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous example, we wrote our very first SQL query, which involves the
    `SELECT` statement. This time, we will learn how to use some other SQL statements,
    such as `INSERT`, `UPDATE`, and `DELETE`.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: How to do it…
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let''s create a simple program that demonstrates basic SQL query commands by
    following these steps:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: We can use our previous project files, but there are couples of things we need
    to change. First, open up `mainwindow.ui` and replace the labels for name and
    age with line edit widgets. Then, add three buttons to the canvas and call them
    **Update**, **Insert**, and **Delete**:![How to do it…](img/B02820_08_11.jpg)
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'After that, open up `mainwindow.h` and add the following variables under private
    inheritance:'
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Next, open up `mainwindow.cpp` and go to the class constructor. It is still
    pretty much the same as the previous example, except we store the database connection
    status in a Boolean variable called `connected` and we also obtain the ID of the
    data from the database and store it to an integer variable called `currentID`:'
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Then, go to `mainwindow.ui` and right-click on one of the buttons we added
    to the canvas in step 1\. Select **Go to slot…** and click **OK**. Repeat these
    steps on the other button, and now you should see three slot functions being added
    to both your `mainwindow.h` and `mainwindow.cpp`:'
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'After that, open up `mainwindow.cpp` and we will declare what the program will
    do when we click on the **Update** button:'
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Once you have done that, we will proceed to declare what will happen when the
    **Insert** button is clicked:'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'After that, we also declare what will happen when the **Delete** button is
    clicked:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Lastly, call `QSqlDatabase::close()` at the class destructor to properly terminate
    the SQL connection before exiting the program:'
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Compile and run the program now and you should be able to select the default
    data from the database; then you can choose to update it or delete it from the
    database. You can also insert new data into the database by clicking the **Insert**
    button. You can use phpMyAdmin to check whether the data is being altered correctly
    or not:![How to do it…](img/B02820_08_12.jpg)
  id: totrans-78
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works…
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It's very important to check whether or not the database is connected in the
    first place before we proceed to send a SQL query to the database. Therefore,
    we keep that status in a variable and use it to check before sending out any queries.
    This, however, is not recommended for complex programs that are kept open for
    long periods of time, as the database might get disconnected during these periods,
    and a fixed variable may not be accurate. In that case, it's better to check the
    actual status by calling `QSqlDatabase::isOpen()`.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: The `currentID` variable is used to save the ID of the current data you obtained
    from the database. When you want to update the data or delete it from the database,
    this variable is crucial for letting the database know which data you're trying
    to update or delete. If you set your database table correctly, MySQL will treat
    each item of data as a unique entry, so you can be sure that no repeated ID will
    be produced in the database when new data is being saved.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: After inserting new data into the database, we call `QSqlQuery::lastInsertId()`
    to obtain the ID of the new data and save it as a `currentID` variable, so that
    it becomes the current data that we can update or delete from the database.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: It is a good habit to test your SQL queries on phpMyAdmin first before using
    them in Qt. You can instantly find out whether your SQL statements are correct
    or incorrect, instead of waiting for your project to get built, then try it out,
    then rebuild again. As a programmer, we must work in the most efficient way. Work
    hard, and work smart.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: Creating a login screen with Qt
  id: totrans-84
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will learn how put our knowledge to use and create a functional
    login screen using Qt and MySQL.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: How to do it…
  id: totrans-86
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Create your first functional login screen by following these steps:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
- en: First, open up a web browser and go to phpMyAdmin. We will create a new data
    table called `user`, which looks like this:![How to do it…](img/B02820_08_13.jpg)
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Next, insert our first item of data into the newly created table and set the
    `employeeID` to the ID of an existing employee's data. This way, the user account
    we created will be linked to the data of one of the employees:![How to do it…](img/B02820_08_14.jpg)
  id: totrans-89
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After that, open up Qt Creator and create a new **Qt Widgets Application** project.
    We will start off with `mainwindow.ui`. First, place a stacked widget on the canvas
    and make sure it contains two pages. Then, set up the two pages in the stacked
    widget like this:![How to do it…](img/B02820_08_15.jpg)
  id: totrans-90
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Then, on the first page of the stacked widget, click the **Edit Tab Order**
    button on top of the widget so that we can adjust the order of the widgets in
    our program:![How to do it…](img/B02820_08_16.jpg)
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once you click the **Edit Tab Order** button, you will see some numbers appear
    on top of each widget in the canvas. Make sure the numbers look like this. Otherwise,
    click on the numbers to change their order. We only do this for the first page
    of the stacked widget; it's okay to keep the second page as it is:![How to do
    it…](img/B02820_08_17.jpg)
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Next, right-click on the **Login** button and select **Go to slot…**. Then,
    make sure the **clicked()** option is selected and press **OK**. Qt will then
    create a slot function for you in your project source files. Repeat this step
    for the **Log Out** button as well.
  id: totrans-93
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Then, open up `mainwindow.h` and add the following headers after the line `#include
    <QMainWindow>`:'
  id: totrans-94
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'After that, add the following variable to `mainwindow.h`:'
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Once we''re done with that, let''s open up `mainwindow.cpp` and put this code
    in the class constructor:'
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'After that, we will define what will happen if the **Login** button is clicked:'
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Then, we also define what will happen if the **Log Out** button is clicked:'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Lastly, close the database when the main window is closed:'
  id: totrans-104
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Compile and run the program now and you should be able to log in with the dummy
    account. After you have logged in, you should be able to see the dummy employee
    information linked to the user account. You can also log out by clicking on the
    **Log Out** button:![How to do it…](img/B02820_08_18.jpg)
  id: totrans-106
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works…
  id: totrans-107
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this example, we select data from the `user` table that matches the username
    and password that we have inserted into the text fields. If nothing is found,
    it means we have provided an invalid username or password. Otherwise, obtain the
    `employeeID` data from the user account and do another SQL query to look for information
    from the `employee` table that matches the `employeeID` variable. Then, display
    the data accordingly to the UI of our program.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
- en: We must set the widget order in the **Edit Tab Order** mode so that when the
    program has started, the first widget that gets focused on is the username line
    edit widget. If the user presses on the **TAB** button on the keyboard, the focus
    should switch to the second widget, which is the password line edit. Incorrect
    widget order will totally ruin the user experience and drive away your potential
    users.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: Do make sure that the **echoMode** option of the password line edit is set to
    `Password`. That setting will hide the actual password inserted into the line
    edit and replace it with dot symbols for security purposes.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: Displaying information from a database on a model view
  id: totrans-111
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will learn how to display multiple sets of data obtained
    from our SQL database on a model view in our program.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
- en: How to do it…
  id: totrans-113
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Follow these steps to display information from a database on a model view widget:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: We will be using the database table called `employee`, which we used in the
    previous example. This time, we need a lot more data in the `employee` table.
    Open up your web browser and log in to your phpMyAdmin control panel. Add data
    for a few more employees so that we can display it later in our program:![How
    to do it…](img/B02820_08_19.jpg)
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After that, open up Qt Creator, create a new **Qt Widgets Application** project,
    and then add the SQL module to your project.
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Next, open up `mainwindow.ui` and add a table widget (not table view) from **Item
    Widget (Item-Based)** under the **Widget** box pane. Select the main window on
    the canvas and click on either the **Layout Vertically** or **Layout Horizontally**
    button to make the table widget stick to the size of the main window, even when
    it's resized:![How to do it…](img/B02820_08_20.jpg)
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After that, double-click on the table widget and a window will then appear.
    Under the **Columns** tab, add five items by clicking on the **+** button at the
    top-left corner. Name the items `ID`, `Name`, `Age`, `Gender`, and `Married`.
    Click **OK** when you're done:![How to do it…](img/B02820_08_21.jpg)
  id: totrans-118
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Then, right-click on the table widget and select **Go to slot…** in the pop-up
    menu. Scroll all the way down, select the **itemChanged(QTableWidgetItem*)** option
    in the pop-up window, and press **OK**. A slot function will be created in both
    your source files.
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Open up `mainwindow.h` and add these private variables to our `MainWindow`
    class:'
  id: totrans-120
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'We also add the following class headers to `mainwindow.h`:'
  id: totrans-122
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Once you''re done with that, open up `mainwindow.cpp` and we''re going to write
    tons of code there. First, we need to declare what will happen when the program
    is started. Add the following code to the constructor of the `MainWindow` class:'
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'After that, declare what will happen when an item of the table widget has been
    edited. Add the following code to the slot function called `on_tableWidget_itemChanged()`:'
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Lastly, close the database at the class destructor:'
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Compile and run the example now and you should be getting something like this:![How
    to do it…](img/B02820_08_22.jpg)
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works…
  id: totrans-131
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A table widget is similar to the one you see in spreadsheet applications such
    as Microsoft Excel and Open Office Calc. In contrast with other types of model
    viewers such as list view or tree view, table view (or table widget) is a two-dimensional
    model viewer, which displays data in the form of rows and columns.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: The main difference between a table view and table widget in Qt is that a table
    widget is built on top of a table view class, which means a table widget is easier
    to use and more suitable for beginners. However, a table widget is less flexible
    and tends to be less scalable than a table view, which is not the best choice
    if you want to customize your table.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
- en: After retrieving data from MySQL, we created a `QTableWidgetItem` item for each
    of the data items and set which column and row should be added to the table widget.
    Before adding an item to the table widget, we must increase the row count of the
    table by calling `QTableWidget::setRowCount()`. We can also get the current row
    count of the table widget by simply calling `QTableWidget::rowCount()`.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: The first column from the left is hidden from view because we only use it to
    save the ID of the data so that we can use it to update the database when one
    of the data items in its row has changed.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: The slot function `on_tableWidget_itemChanged()` will be called when the data
    in one of the cells has changed. It will not only get called when you edit the
    data in the cell, but also when the data is first added to the table after being
    retrieved from the database. To ensure that this function is only triggered when
    we edit the data, we used a Boolean variable called `hasInit` to check whether
    we have done the initialization process (adding the first batch of data to the
    table) or not. If `hasInit` is `false`, ignore the function call.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: To prevent users from entering a totally irrelevant type of data, such as inserting
    alphabets into a supposedly numerical-only data cell, we checked manually whether
    the data is anything close to what we'd expected when it's being edited. Revert
    it to a default value if it doesn't come close to anything considered as valid.
    This is of course a simple hack, which does the job but is not the most professional
    method. Alternatively, you can try to create a new class that inherits the `QItemDelegate`
    class and define how your model view should behave. Then, call `QTableWidget::setItemDelegate()`
    to apply the class to your table widget.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: Advanced SQL queries
  id: totrans-138
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: By following this recipe, we will learn how to use advanced SQL statements such
    as `INNER JOIN`, `COUNT`, `LIKE`, `DISTINCT`, and so on.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: How to do it…
  id: totrans-140
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'You can do a lot more than just perform simple queries of SQL database:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: First of all, we need to add a few tables to our database before we can dive
    into the programming part. Open up your web browser and access your phpMyAdmin.
    We need several tables for this example to work:![How to do it…](img/B02820_08_23.jpg)
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: I will show you the structure of each of the tables required for this project
    and the dummy data inserted to the tables for testing. The first table is called
    `branch`, which is used to store the IDs and names of different branches of the
    dummy company:![How to do it…](img/B02820_08_24.jpg)
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Secondly, we have the `department` table, which stores the IDs and names of
    different departments of the dummy company, which is also linked to the branch
    data by the branch IDs:![How to do it…](img/B02820_08_25.jpg)
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Next, we also have an `employee` table, which stores the information of all
    the employees in the dummy company. This table is similar to the one we used in
    the previous examples, except it has two more extra columns, namely `birthday`
    and `departmentID`:![How to do it…](img/B02820_08_26.jpg)
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Other than that, we also have a table called `log`, which contains dummy records
    of the login time for each employee. The `loginTime` column can be a `timestamp`
    or `date time` variable type:![How to do it…](img/B02820_08_27.jpg)
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Lastly, we have the `user` table that we also used in the previous examples:![How
    to do it…](img/B02820_08_28.jpg)
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We are done with the database; let's move on to Qt. Open up Qt Creators, and
    this time, instead of choosing **Qt Widgets Application**, we create **Qt Console
    Application**:![How to do it…](img/B02820_08_29.jpg)
  id: totrans-148
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'After you have done creating your console project, open up your project file
    (`.pro`) and add the SQL module to your project:'
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Next, open up `main.cpp` and add the following header files to the top of the
    source file:'
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Then, add the following function to display employees who are above 30 years
    old:'
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'After that, add this function for displaying the department and branch information
    of each employee:'
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Next, add this function, which displays employees who are working in the `New
    York` branch and are below 30 years old:'
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Then, add this function which counts the total number of female employees in
    the dummy company:'
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-160
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Once you''re done with that, we will add another function, which filters the
    employee list and only displays those who have name that starts with `Ja`:'
  id: totrans-161
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-162
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'Next, we also add another function, which displays employees who have their
    birthdays in `August`:'
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'Then, we add the last function, which checks who logged in to the dummy system
    on `27 April 2016` and displays their names on the terminal:'
  id: totrans-165
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Lastly, in our `main()` function, connect our program to the MySQL database
    and call all the functions that we have defined in the previous steps. After that,
    close the database connection and we''re done:'
  id: totrans-167
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Compile and run the project now and you should see a terminal window, which
    displays the filtered results from the database as defined earlier:![How to do
    it…](img/B02820_08_30.jpg)
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works…
  id: totrans-170
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A console application does not have any GUI at all and only shows you a text
    display in a terminal window. This is usually used in a backend system, as it
    uses fewer resources compared to a widget application. We use it in this example
    because it's faster to display the result without the need to place any widgets
    in the program, which we don't need in this case.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
- en: We separated the SQL queries into different functions so that it's easier to
    maintain the code and it doesn't become too messy. Do note that in C++, the functions
    have to be located before the `main()` function, or they will not be able to be
    called by `main()`.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: There's more…
  id: totrans-173
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The `INNER JOIN` statement used in the preceding example joins two tables together
    and selects all rows from both tables, as long as there is a match between the
    columns in both tables. There are many other types of `JOIN` statement that you
    can use in MySQL (and some other types of SQL architecture), such as `LEFT JOIN`,
    `RIGHT JOIN`, `FULL OUTER JOIN`, and so on. The following diagram shows the different
    types of `JOIN` statements and their effects:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: '![There''s more…](img/B02820_08_31.jpg)'
  id: totrans-175
  prefs: []
  type: TYPE_IMG
- en: The `LIKE` statement is normally used to search for a string variable in the
    database without the full word. Notice that there are two `%` symbols, located
    before and after the search keyword.
  id: totrans-176
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The `DISTINCT` statement used in the previous example filters out results that
    have the exact same variable. For example, without the `DISTINCT` statement, you
    will see two versions of Larry King appear in the terminal because there are two
    records of him logging in to the system on the same day. By adding the `DISTINCT`
    statement, MySQL will eliminate one of the repeating results and ensure every
    result is unique.
  id: totrans-177
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You may be wondering what `d-MMMM-yyyy` stands for and why we used it in the
    preceding example. That is actually an expression supplied to the `QDateTime`
    class in Qt to display the date time result using a given format. In this case,
    it will change the date time data that we get from MySQL, `2016-08-06`, to the
    format that we specified, resulting in `6-August-2016`. For more information,
    check out Qt's documentation at [http://doc.qt.io/qt-5/qdatetime.html#toString](http://doc.qt.io/qt-5/qdatetime.html#toString),
    which has the full list of expressions that can be used to determine the format
    of the date and time string.
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可能想知道`d-MMMM-yyyy`代表什么，为什么我们在前面的例子中使用它。这实际上是提供给Qt中的`QDateTime`类的一个表达式，用于使用给定的格式显示日期时间结果。在这种情况下，它将改变我们从MySQL获取的日期时间数据`2016-08-06`，转换为我们指定的格式，结果为`6-August-2016`。更多信息，请查看Qt的文档[http://doc.qt.io/qt-5/qdatetime.html#toString](http://doc.qt.io/qt-5/qdatetime.html#toString)，其中包含可以用来确定日期和时间字符串格式的完整表达式列表。
